<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiabetesTracker Pro - Complete Health Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Author: Marian Barsoum marian_barsoum@outlook.com -->
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen">
    <!-- Medication Reminder Modal -->
    <div id="reminder-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 animate-pulse">
            <div class="text-center">
                <div class="text-4xl mb-4 animate-bounce">‚è∞</div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">Medication Reminder</h2>
                <p class="text-gray-600 mb-4" id="reminder-message">Time for your medication!</p>
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                    <p class="font-bold">üîî ALARM ACTIVE</p>
                    <p class="text-sm">Please take your medication or snooze the reminder</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="snoozeReminder()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                        Snooze 15min
                    </button>
                    <button onclick="dismissReminder()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                        Taken ‚úì
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointment Reminder Modal -->
    <div id="appointment-reminder-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 animate-pulse">
            <div class="text-center">
                <div class="text-4xl mb-4 animate-bounce">üìÖ</div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">Appointment Reminder</h2>
                <p class="text-gray-600 mb-4" id="appointment-reminder-message">You have an upcoming appointment!</p>
                <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4">
                    <p class="font-bold">üîî REMINDER ACTIVE</p>
                    <p class="text-sm">Don't forget your upcoming appointment</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="snoozeAppointmentReminder()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                        Remind Later
                    </button>
                    <button onclick="dismissAppointmentReminder()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                        Got It ‚úì
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Setup Modal -->
    <div id="profile-setup-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Welcome to DiabetesTracker Pro</h2>
            <p class="text-gray-600 mb-6 text-center">Let's set up your profile to get started:</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Age</label>
                    <input type="number" id="setup-age" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Enter your age" min="1" max="120">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sex</label>
                    <select id="setup-sex" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Select sex</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Height</label>
                    <div class="mb-2">
                        <select id="setup-height-unit" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="toggleHeightUnits()">
                            <option value="imperial">Imperial (Feet & Inches)</option>
                            <option value="metric">Metric (Centimeters)</option>
                        </select>
                    </div>
                    <div id="height-imperial" class="grid grid-cols-2 gap-2">
                        <input type="number" id="setup-height-feet" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Feet" min="3" max="8">
                        <input type="number" id="setup-height-inches" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Inches" min="0" max="11">
                    </div>
                    <div id="height-metric" class="hidden">
                        <input type="number" id="setup-height-cm" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Height in cm" min="100" max="250">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Diabetes Type</label>
                    <select id="setup-diabetes-type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Select diabetes type</option>
                        <option value="Type 1">Type 1 Diabetes</option>
                        <option value="Type 2">Type 2 Diabetes</option>
                        <option value="Gestational">Gestational Diabetes</option>
                        <option value="Pre-diabetes">Pre-diabetes</option>
                    </select>
                </div>
                
                <button onclick="completeProfileSetup()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors mt-6">
                    Complete Setup
                </button>
            </div>
        </div>
    </div>

    <!-- Diabetes Type Selection Modal -->
    <div id="diabetes-type-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Change Diabetes Type</h2>
            <p class="text-gray-600 mb-6 text-center">Select your diabetes type:</p>
            
            <div class="space-y-4">
                <button onclick="selectDiabetesType('Type 1')" class="w-full p-4 border-2 border-blue-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-all text-left">
                    <div class="flex items-center">
                        <div class="w-4 h-4 border-2 border-blue-400 rounded-full mr-3"></div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Type 1 Diabetes</h3>
                            <p class="text-sm text-gray-600">Insulin-dependent diabetes</p>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectDiabetesType('Type 2')" class="w-full p-4 border-2 border-green-200 rounded-lg hover:border-green-400 hover:bg-green-50 transition-all text-left">
                    <div class="flex items-center">
                        <div class="w-4 h-4 border-2 border-green-400 rounded-full mr-3"></div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Type 2 Diabetes</h3>
                            <p class="text-sm text-gray-600">Most common form of diabetes</p>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectDiabetesType('Gestational')" class="w-full p-4 border-2 border-purple-200 rounded-lg hover:border-purple-400 hover:bg-purple-50 transition-all text-left">
                    <div class="flex items-center">
                        <div class="w-4 h-4 border-2 border-purple-400 rounded-full mr-3"></div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Gestational Diabetes</h3>
                            <p class="text-sm text-gray-600">Diabetes during pregnancy</p>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectDiabetesType('Pre-diabetes')" class="w-full p-4 border-2 border-orange-200 rounded-lg hover:border-orange-400 hover:bg-orange-50 transition-all text-left">
                    <div class="flex items-center">
                        <div class="w-4 h-4 border-2 border-orange-400 rounded-full mr-3"></div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Pre-diabetes</h3>
                            <p class="text-sm text-gray-600">Higher than normal blood sugar</p>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div id="success-message" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-green-500 text-white p-4 rounded-lg shadow-lg">
            <p class="font-semibold">Success!</p>
            <p class="text-sm" id="success-text">Action completed successfully</p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ü©∫ DiabetesTracker Pro</h1>
            <p class="text-gray-600">Complete diabetes health monitoring system</p>
            
            <!-- Language Selector -->
            <div class="flex justify-center mb-4">
                <div class="bg-white rounded-lg shadow-md p-2">
                    <select id="language-selector" onchange="changeLanguage()" class="px-3 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 text-sm">
                        <option value="en">üá∫üá∏ English</option>
                        <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                        <option value="es">üá™üá∏ Espa√±ol</option>
                    </select>
                </div>
            </div>

            <div id="profile-display" class="mt-4 hidden">
                <div class="flex flex-wrap justify-center gap-2 mb-2">
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                        <span id="current-diabetes-type">Type 2</span> <span data-translate="diabetes">Diabetes</span>
                    </span>
                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                        <span data-translate="age">Age</span>: <span id="current-age">--</span>
                    </span>
                    <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">
                        <span id="current-sex">--</span>
                    </span>
                    <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-medium">
                        <span data-translate="height">Height</span>: <span id="current-height">--</span>
                    </span>
                </div>
                <div class="flex justify-center gap-4">
                    <button onclick="editProfile()" class="text-blue-600 hover:text-blue-800 text-sm underline" data-translate="edit_profile">
                        Edit Profile
                    </button>
                    <button onclick="testAlarm()" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm font-medium">
                        üîî <span data-translate="test_alarm">Test Alarm</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Stats Dashboard -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="avg-glucose">--</div>
                <div class="text-sm text-gray-600" data-translate="avg_glucose">Avg Glucose</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="current-weight">--</div>
                <div class="text-sm text-gray-600" data-translate="current_weight">Current Weight</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="current-bmi">--</div>
                <div class="text-sm text-gray-600" data-translate="bmi">BMI</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-red-600" id="last-bp">--</div>
                <div class="text-sm text-gray-600" data-translate="blood_pressure">Blood Pressure</div>
            </div>
        </div>

        <!-- Gamification Progress Bar -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="text-3xl mr-3" id="user-level-badge">üèÜ</div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Level <span id="user-level">1</span> Diabetes Champion</h3>
                        <p class="text-sm text-gray-600"><span id="user-points">0</span> points ‚Ä¢ <span id="streak-days">0</span> day streak</p>
                    </div>
                </div>
                <div class="text-right">
                    <button onclick="showTab('achievements')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                        üèÖ Achievements
                    </button>
                </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="level-progress" class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p class="text-xs text-gray-500 mt-2"><span id="points-to-next">100</span> points to next level</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex flex-wrap justify-center mb-8 bg-white rounded-lg shadow-md p-2">
            <button onclick="showTab('glucose')" id="glucose-tab" class="tab-btn bg-blue-500 text-white px-3 py-2 rounded-lg mx-1 mb-2 font-semibold transition-all text-sm">
                ü©∏ Blood Glucose
            </button>
            <button onclick="showTab('insulin')" id="insulin-tab" class="tab-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg mx-1 mb-2 font-semibold transition-all hover:bg-gray-300 text-sm">
                üíâ Insulin
            </button>
            <button onclick="showTab('medication')" id="medication-tab" class="tab-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg mx-1 mb-2 font-semibold transition-all hover:bg-gray-300 text-sm">
                üíä Medications
            </button>
            <button onclick="showTab('food')" id="food-tab" class="tab-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg mx-1 mb-2 font-semibold transition-all hover:bg-gray-300 text-sm">
                üçé Food & Carbs
            </button>
            <button onclick="showTab('exercise')" id="exercise-tab" class="tab-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg mx-1 mb-2 font-semibold transition-all hover:bg-gray-300 text-sm">
                üèÉ Exercise
            </button>
            <button onclick="showTab('vitals')" id="vitals-tab" class="tab-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg mx-1 mb-2 font-semibold transition-all hover:bg-gray-300 text-sm">
                üìä Vitals
            </button>
            <button onclick="showTab('hba1c')" id="hba1c-tab" class="tab-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg mx-1 mb-2 font-semibold transition-all hover:bg-gray-300 text-sm">
                üß™ HbA1c
            </button>
            <button onclick="showTab('appointments')" id="appointments-tab" class="tab-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg mx-1 mb-2 font-semibold transition-all hover:bg-gray-300 text-sm">
                üìÖ Appointments
            </button>
            <button onclick="showTab('messages')" id="messages-tab" class="tab-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg mx-1 mb-2 font-semibold transition-all hover:bg-gray-300 text-sm">
                üí¨ Messages
            </button>
            <button onclick="showTab('achievements')" id="achievements-tab" class="tab-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg mx-1 mb-2 font-semibold transition-all hover:bg-gray-300 text-sm">
                üèÖ Achievements
            </button>
            <button onclick="showTab('labs')" id="labs-tab" class="tab-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg mx-1 mb-2 font-semibold transition-all hover:bg-gray-300 text-sm">
                üß™ Lab Results
            </button>
            <button onclick="showTab('med-manager')" id="med-manager-tab" class="tab-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg mx-1 mb-2 font-semibold transition-all hover:bg-gray-300 text-sm">
                üíä Medication Manager
            </button>
            <button onclick="showTab('export')" id="export-tab" class="tab-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg mx-1 mb-2 font-semibold transition-all hover:bg-gray-300 text-sm">
                üì§ Export Data
            </button>
            <button onclick="showTab('health-summary')" id="health-summary-tab" class="tab-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg mx-1 mb-2 font-semibold transition-all hover:bg-gray-300 text-sm">
                üìã Health Summary
            </button>
        </div>

        <!-- Blood Glucose Tab -->
        <div id="glucose-content" class="tab-content">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Add Glucose Reading -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">ü©∏ Log Blood Glucose</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Glucose Level (mg/dL)</label>
                            <input type="number" id="glucose-level" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter reading">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Time of Reading</label>
                            <select id="glucose-time" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="fasting">Fasting</option>
                                <option value="before-breakfast">Before Breakfast</option>
                                <option value="after-breakfast">After Breakfast (2hrs)</option>
                                <option value="before-lunch">Before Lunch</option>
                                <option value="after-lunch">After Lunch (2hrs)</option>
                                <option value="before-dinner">Before Dinner</option>
                                <option value="after-dinner">After Dinner (2hrs)</option>
                                <option value="bedtime">Bedtime</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                            <textarea id="glucose-notes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="2" placeholder="Any additional notes..."></textarea>
                        </div>
                        <button onclick="addGlucoseReading()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            Add Reading
                        </button>
                    </div>
                </div>

                <!-- Recent Glucose Readings -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìã Recent Readings</h2>
                    <div id="glucose-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Readings will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Insulin Tab -->
        <div id="insulin-content" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Add Insulin Dose -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üíâ Log Insulin Dose</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Insulin Type</label>
                            <select id="insulin-type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="rapid-acting">Rapid-Acting (Humalog, NovoLog)</option>
                                <option value="short-acting">Short-Acting (Regular)</option>
                                <option value="intermediate">Intermediate-Acting (NPH)</option>
                                <option value="long-acting">Long-Acting (Lantus, Levemir)</option>
                                <option value="ultra-long">Ultra Long-Acting (Tresiba)</option>
                                <option value="mixed">Mixed Insulin</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dosage (units)</label>
                                <input type="number" id="insulin-dose" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="10" step="0.5">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Injection Site</label>
                                <select id="insulin-site" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="abdomen">Abdomen</option>
                                    <option value="thigh">Thigh</option>
                                    <option value="arm">Upper Arm</option>
                                    <option value="buttocks">Buttocks</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Injection</label>
                            <select id="insulin-reason" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="meal">Before Meal</option>
                                <option value="correction">Correction Dose</option>
                                <option value="basal">Basal/Background</option>
                                <option value="bedtime">Bedtime</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Blood Glucose Before (mg/dL)</label>
                            <input type="number" id="insulin-bg-before" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="120">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                            <textarea id="insulin-notes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="2" placeholder="Carbs consumed, exercise planned, etc."></textarea>
                        </div>
                        <button onclick="addInsulinDose()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            Log Insulin Dose
                        </button>
                    </div>
                </div>

                <!-- Recent Insulin Doses -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìã Recent Insulin Doses</h2>
                    <div id="insulin-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Insulin doses will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Medication Tab -->
        <div id="medication-content" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Add Medication -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üíä Log Medication</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Medication Name</label>
                            <input type="text" id="med-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="e.g., Metformin">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dosage</label>
                                <input type="text" id="med-dosage" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="500mg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Frequency</label>
                                <select id="med-frequency" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="once-daily">Once Daily</option>
                                    <option value="twice-daily">Twice Daily</option>
                                    <option value="three-times">Three Times Daily</option>
                                    <option value="four-times">Four Times Daily</option>
                                    <option value="as-needed">As Needed</option>
                                    <option value="weekly">Weekly</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Reminder Times</label>
                            <input type="text" id="med-times" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="08:00, 20:00 (for twice daily)">
                            <p class="text-xs text-gray-500 mt-1">Enter times separated by commas (24-hour format)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                            <textarea id="med-notes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" rows="2" placeholder="With food, side effects, etc."></textarea>
                        </div>
                        <button onclick="addMedication()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            Add Medication & Set Reminders
                        </button>
                    </div>
                </div>

                <!-- Medication Schedule -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìã Today's Medication Schedule</h2>
                    <div id="medication-schedule" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Schedule will be populated here -->
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="font-semibold text-gray-800 mb-3">Recent Medications</h3>
                        <div id="medication-list" class="space-y-3 max-h-64 overflow-y-auto">
                            <!-- Recent medications will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Food & Carbs Tab -->
        <div id="food-content" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Add Food -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üçΩÔ∏è Log Food & Carbohydrates</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Food Item</label>
                            <input type="text" id="food-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="e.g., Apple, Oatmeal, Pasta">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                                <input type="number" id="food-quantity" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="1" step="0.1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Unit</label>
                                <select id="food-unit" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="piece">piece</option>
                                    <option value="cup">cup</option>
                                    <option value="oz">oz</option>
                                    <option value="gram">gram</option>
                                    <option value="slice">slice</option>
                                    <option value="tbsp">tablespoon</option>
                                    <option value="tsp">teaspoon</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Calories</label>
                                <input type="number" id="food-calories" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="80">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Carbs (g)</label>
                                <input type="number" id="food-carbs" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="20" step="0.1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fiber (g)</label>
                                <input type="number" id="food-fiber" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="3" step="0.1">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Meal Type</label>
                            <select id="meal-type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="breakfast">Breakfast</option>
                                <option value="lunch">Lunch</option>
                                <option value="dinner">Dinner</option>
                                <option value="snack">Snack</option>
                            </select>
                        </div>
                        <button onclick="addFoodItem()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            Add Food Item
                        </button>
                    </div>
                </div>

                <!-- Daily Summary -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä Today's Nutrition Summary</h2>
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold text-blue-800">Total Calories</span>
                                <span id="total-calories" class="text-2xl font-bold text-blue-600">0</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2 mt-2">
                                <div id="calories-bar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-blue-600 mt-1">Goal: 2000 calories</p>
                        </div>
                        
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold text-orange-800">Total Carbs</span>
                                <span id="total-carbs" class="text-2xl font-bold text-orange-600">0g</span>
                            </div>
                            <div class="w-full bg-orange-200 rounded-full h-2 mt-2">
                                <div id="carbs-bar" class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-orange-600 mt-1">Goal: 150g carbs</p>
                        </div>

                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold text-green-800">Net Carbs</span>
                                <span id="net-carbs" class="text-2xl font-bold text-green-600">0g</span>
                            </div>
                            <p class="text-sm text-green-600 mt-1">Total carbs minus fiber</p>
                        </div>
                    </div>

                    <div class="mt-6">
                        <h3 class="font-semibold text-gray-800 mb-3">Today's Meals</h3>
                        <div id="meals-list" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- Meals will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exercise Tab -->
        <div id="exercise-content" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Add Exercise -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üèÉ Log Physical Activity</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Exercise Type</label>
                            <select id="exercise-type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="walking">Walking</option>
                                <option value="running">Running</option>
                                <option value="cycling">Cycling</option>
                                <option value="swimming">Swimming</option>
                                <option value="strength">Strength Training</option>
                                <option value="yoga">Yoga</option>
                                <option value="dancing">Dancing</option>
                                <option value="sports">Sports</option>
                                <option value="housework">Housework</option>
                                <option value="gardening">Gardening</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Duration (minutes)</label>
                                <input type="number" id="exercise-duration" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="30">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Intensity</label>
                                <select id="exercise-intensity" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="light">Light</option>
                                    <option value="moderate">Moderate</option>
                                    <option value="vigorous">Vigorous</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">BG Before Exercise</label>
                                <input type="number" id="exercise-bg-before" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="120">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">BG After Exercise</label>
                                <input type="number" id="exercise-bg-after" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="110">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                            <textarea id="exercise-notes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" rows="2" placeholder="How did you feel? Any observations?"></textarea>
                        </div>
                        <button onclick="addExercise()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            Log Exercise
                        </button>
                    </div>
                </div>

                <!-- Exercise Summary -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä Today's Activity Summary</h2>
                    <div class="space-y-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold text-green-800">Total Exercise Time</span>
                                <span id="total-exercise-time" class="text-2xl font-bold text-green-600">0 min</span>
                            </div>
                            <div class="w-full bg-green-200 rounded-full h-2 mt-2">
                                <div id="exercise-time-bar" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-green-600 mt-1">Goal: 150 minutes/week</p>
                        </div>
                    </div>

                    <div class="mt-6">
                        <h3 class="font-semibold text-gray-800 mb-3">Recent Activities</h3>
                        <div id="exercise-list" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- Exercises will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vitals Tab (Weight, BMI, Blood Pressure) -->
        <div id="vitals-content" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Add Vitals -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä Log Vital Signs</h2>
                    
                    <!-- Weight Section -->
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-3">‚öñÔ∏è Weight Tracking</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Weight</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <input type="number" id="weight-value" class="col-span-2 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="150" step="0.1">
                                    <select id="weight-unit" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="lbs">lbs</option>
                                        <option value="kg">kg</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                <input type="date" id="weight-date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <button onclick="addWeight()" class="w-full mt-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            Add Weight Entry
                        </button>
                    </div>

                    <!-- Blood Pressure Section -->
                    <div class="mb-6 p-4 bg-red-50 rounded-lg">
                        <h3 class="font-semibold text-red-800 mb-3">ü©∫ Blood Pressure</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Systolic</label>
                                <input type="number" id="bp-systolic" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="120">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Diastolic</label>
                                <input type="number" id="bp-diastolic" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="80">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pulse</label>
                                <input type="number" id="bp-pulse" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="72">
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                            <textarea id="bp-notes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" rows="2" placeholder="Time of day, position, etc."></textarea>
                        </div>
                        <button onclick="addBloodPressure()" class="w-full mt-3 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            Add BP Reading
                        </button>
                    </div>
                </div>

                <!-- Vitals Summary -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìà Vitals Summary</h2>
                    
                    <!-- BMI Display -->
                    <div id="bmi-display" class="mb-6 p-4 rounded-lg bg-gray-50 border-l-4 border-gray-400">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">Body Mass Index (BMI)</p>
                                <p class="text-3xl font-bold text-gray-600" id="bmi-value">--</p>
                            </div>
                            <div class="text-right">
                                <span class="text-gray-600 font-bold" id="bmi-category">Enter weight</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Weight Entries -->
                    <div class="mb-6">
                        <h3 class="font-semibold text-gray-800 mb-3">Recent Weight Entries</h3>
                        <div id="weight-list" class="space-y-2 max-h-32 overflow-y-auto">
                            <!-- Weight entries will be populated here -->
                        </div>
                    </div>

                    <!-- Recent BP Readings -->
                    <div class="mb-6">
                        <h3 class="font-semibold text-gray-800 mb-3">Recent Blood Pressure</h3>
                        <div id="bp-list" class="space-y-2 max-h-32 overflow-y-auto">
                            <!-- BP readings will be populated here -->
                        </div>
                    </div>

                    <!-- HbA1C Tracking -->
                    <div class="mb-6">
                        <h3 class="font-semibold text-gray-800 mb-3">HbA1C History</h3>
                        <div id="hba1c-current" class="mb-4 p-4 rounded-lg bg-gray-50 border-l-4 border-gray-400">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-semibold text-gray-800">Latest HbA1C</p>
                                    <p class="text-3xl font-bold text-gray-600" id="current-hba1c">--</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-gray-600 font-bold" id="hba1c-status">No results yet</span>
                                    <p class="text-sm text-gray-500" id="hba1c-date-display">--</p>
                                </div>
                            </div>
                        </div>
                        <div id="hba1c-list" class="space-y-2 max-h-32 overflow-y-auto">
                            <!-- HbA1C readings will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HbA1c Tab -->
        <div id="hba1c-content" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Add HbA1C -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üß™ HbA1C (Hemoglobin A1C) Tracking</h2>
                    <p class="text-gray-600 mb-6">Track your 3-month average blood sugar levels - the gold standard for diabetes management</p>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">HbA1C Percentage (%)</label>
                                <input type="number" id="hba1c-value" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="7.0" step="0.1" min="0.1" max="20.0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Test Date</label>
                                <input type="date" id="hba1c-date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Lab/Doctor Name</label>
                            <input type="text" id="hba1c-lab" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="e.g., Quest Diagnostics, Dr. Smith">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                            <textarea id="hba1c-notes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" rows="3" placeholder="Any changes in medication, lifestyle, diet, etc."></textarea>
                        </div>
                        <button onclick="addHbA1C()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            Add HbA1C Result
                        </button>
                    </div>
                    
                    <!-- HbA1C Reference Guide -->
                    <div class="mt-6 p-4 bg-purple-50 rounded-lg border">
                        <h4 class="font-medium text-purple-800 mb-3">üìä HbA1C Reference Ranges:</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between items-center p-2 bg-green-100 rounded">
                                <span class="text-green-700 font-medium">Normal</span>
                                <span class="text-green-600">&lt; 5.7%</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-yellow-100 rounded">
                                <span class="text-yellow-700 font-medium">Pre-diabetes</span>
                                <span class="text-yellow-600">5.7-6.4%</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-blue-100 rounded">
                                <span class="text-blue-700 font-medium">Good Control</span>
                                <span class="text-blue-600">6.5-7.0%</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-orange-100 rounded">
                                <span class="text-orange-700 font-medium">Fair Control</span>
                                <span class="text-orange-600">7.1-8.0%</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-red-100 rounded">
                                <span class="text-red-700 font-medium">Poor Control</span>
                                <span class="text-red-600">&gt; 8.0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HbA1C History & Trends -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìà HbA1C History & Trends</h2>
                    
                    <!-- Current HbA1C Display -->
                    <div id="hba1c-current" class="mb-6 p-4 rounded-lg bg-gray-50 border-l-4 border-gray-400">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">Latest HbA1C</p>
                                <p class="text-3xl font-bold text-gray-600" id="current-hba1c">--</p>
                            </div>
                            <div class="text-right">
                                <span class="text-gray-600 font-bold" id="hba1c-status">No results yet</span>
                                <p class="text-sm text-gray-500" id="hba1c-date-display">--</p>
                            </div>
                        </div>
                    </div>

                    <!-- HbA1C Goal Setting -->
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-3">üéØ Set Your HbA1C Goal</h3>
                        <div class="flex items-center space-x-4">
                            <input type="number" id="hba1c-goal" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="7.0" step="0.1" min="4.0" max="12.0">
                            <span class="text-blue-700">%</span>
                            <button onclick="setHbA1CGoal()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">
                                Set Goal
                            </button>
                        </div>
                        <p class="text-sm text-blue-600 mt-2">Current Goal: <span id="current-hba1c-goal">7.0%</span></p>
                    </div>

                    <!-- HbA1C History List -->
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-3">üìã HbA1C History</h3>
                        <div id="hba1c-list" class="space-y-3 max-h-64 overflow-y-auto">
                            <!-- HbA1C readings will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages Tab -->
        <div id="messages-content" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Send Message -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üí¨ Send Message to Healthcare Team</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">To</label>
                            <select id="message-recipient" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="doctor">Primary Care Doctor</option>
                                <option value="endocrinologist">Endocrinologist</option>
                                <option value="nurse">Diabetes Nurse</option>
                                <option value="nutritionist">Nutritionist</option>
                                <option value="pharmacist">Pharmacist</option>
                                <option value="support">Support Team</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Subject</label>
                            <input type="text" id="message-subject" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Question about medication, Blood sugar concerns">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                            <select id="message-priority" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="low">Low - General question</option>
                                <option value="normal">Normal - Routine inquiry</option>
                                <option value="high">High - Urgent concern</option>
                                <option value="emergency">Emergency - Immediate attention needed</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                            <textarea id="message-content" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="6" placeholder="Describe your question, concern, or update..."></textarea>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="attach-data" class="mr-2">
                            <label for="attach-data" class="text-sm text-gray-700">Attach recent glucose readings and medication log</label>
                        </div>
                        <button onclick="sendMessage()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            Send Message
                        </button>
                    </div>
                </div>

                <!-- Message History -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üì® Message History</h2>
                    <div id="messages-list" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- Messages will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Achievements Tab -->
        <div id="achievements-content" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Achievement Progress -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üèÖ Your Achievements</h2>
                    <div id="achievements-list" class="space-y-4">
                        <!-- Achievements will be populated here -->
                    </div>
                </div>

                <!-- Daily Challenges -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üéØ Daily Challenges</h2>
                    <div id="daily-challenges" class="space-y-4">
                        <!-- Daily challenges will be populated here -->
                    </div>
                    
                    <!-- Weekly Goals -->
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">üìÖ Weekly Goals</h3>
                        <div id="weekly-goals" class="space-y-3">
                            <!-- Weekly goals will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lab Results Tab -->
        <div id="labs-content" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Add Lab Results -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üß™ Add Lab Results</h2>
                    <p class="text-gray-600 mb-6">Track your regular lab work for comprehensive diabetes and hypertension management</p>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Test Date</label>
                                <input type="date" id="lab-date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Lab/Facility</label>
                                <input type="text" id="lab-facility" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Quest, LabCorp, Hospital Lab">
                            </div>
                        </div>
                        
                        <!-- HbA1c -->
                        <div class="p-4 bg-red-50 rounded-lg border">
                            <h3 class="font-semibold text-red-800 mb-3">ü©∏ HbA1c (Hemoglobin A1C)</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">HbA1c (%)</label>
                                    <input type="number" id="lab-hba1c" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="7.0" step="0.1" min="0.1" max="20.0">
                                </div>
                                <div class="flex items-end">
                                    <span class="text-sm text-gray-600">Normal: &lt;5.7% | Goal: &lt;7.0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Lipid Profile -->
                        <div class="p-4 bg-yellow-50 rounded-lg border">
                            <h3 class="font-semibold text-yellow-800 mb-3">üíõ Lipid Profile</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Total Cholesterol (mg/dL)</label>
                                    <input type="number" id="lab-total-chol" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="200">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">LDL Cholesterol (mg/dL)</label>
                                    <input type="number" id="lab-ldl" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="100">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">HDL Cholesterol (mg/dL)</label>
                                    <input type="number" id="lab-hdl" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="40">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Triglycerides (mg/dL)</label>
                                    <input type="number" id="lab-triglycerides" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="150">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comprehensive Metabolic Panel (CMP) -->
                        <div class="p-4 bg-blue-50 rounded-lg border">
                            <h3 class="font-semibold text-blue-800 mb-3">üî¨ Comprehensive Metabolic Panel (CMP)</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Glucose (mg/dL)</label>
                                    <input type="number" id="lab-glucose" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="100">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Creatinine (mg/dL)</label>
                                    <input type="number" id="lab-creatinine" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="1.0" step="0.1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">eGFR (mL/min/1.73m¬≤)</label>
                                    <input type="number" id="lab-egfr" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="90">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">BUN (mg/dL)</label>
                                    <input type="number" id="lab-bun" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="20">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Sodium (mEq/L)</label>
                                    <input type="number" id="lab-sodium" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="140">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Potassium (mEq/L)</label>
                                    <input type="number" id="lab-potassium" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="4.0" step="0.1">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Liver Function Tests (LFT) -->
                        <div class="p-4 bg-green-50 rounded-lg border">
                            <h3 class="font-semibold text-green-800 mb-3">ü´Ä Liver Function Tests (LFT)</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ALT (U/L)</label>
                                    <input type="number" id="lab-alt" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="30">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">AST (U/L)</label>
                                    <input type="number" id="lab-ast" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="30">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Total Bilirubin (mg/dL)</label>
                                    <input type="number" id="lab-bilirubin" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="1.0" step="0.1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Alkaline Phosphatase (U/L)</label>
                                    <input type="number" id="lab-alk-phos" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="100">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Microalbuminuria -->
                        <div class="p-4 bg-purple-50 rounded-lg border">
                            <h3 class="font-semibold text-purple-800 mb-3">ü´ò Kidney Function - Microalbuminuria</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Microalbumin (mg/L)</label>
                                    <input type="number" id="lab-microalbumin" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="15" step="0.1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ACR (mg/g)</label>
                                    <input type="number" id="lab-acr" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="30" step="0.1">
                                    <p class="text-xs text-gray-500 mt-1">Albumin-to-Creatinine Ratio</p>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                            <textarea id="lab-notes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" rows="3" placeholder="Doctor's comments, medication changes, follow-up recommendations..."></textarea>
                        </div>
                        
                        <button onclick="addLabResults()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            Save Lab Results
                        </button>
                    </div>
                </div>

                <!-- Lab Results History & Trends -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä Lab Results History</h2>
                    
                    <!-- Key Metrics Summary -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-400">
                            <h3 class="font-semibold text-red-800">Latest HbA1c</h3>
                            <p class="text-2xl font-bold text-red-600" id="latest-lab-hba1c">--</p>
                            <p class="text-sm text-red-500" id="latest-lab-hba1c-date">No results</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-400">
                            <h3 class="font-semibold text-yellow-800">Latest LDL</h3>
                            <p class="text-2xl font-bold text-yellow-600" id="latest-lab-ldl">--</p>
                            <p class="text-sm text-yellow-500" id="latest-lab-ldl-date">No results</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400">
                            <h3 class="font-semibold text-blue-800">Latest eGFR</h3>
                            <p class="text-2xl font-bold text-blue-600" id="latest-lab-egfr">--</p>
                            <p class="text-sm text-blue-500" id="latest-lab-egfr-date">No results</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-400">
                            <h3 class="font-semibold text-purple-800">Latest ACR</h3>
                            <p class="text-2xl font-bold text-purple-600" id="latest-lab-acr">--</p>
                            <p class="text-sm text-purple-500" id="latest-lab-acr-date">No results</p>
                        </div>
                    </div>
                    
                    <!-- Lab Schedule Reminders -->
                    <div class="mb-6 p-4 bg-orange-50 rounded-lg border">
                        <h3 class="font-semibold text-orange-800 mb-3">üìÖ Recommended Lab Schedule</h3>
                        <div class="text-sm text-orange-700 space-y-1">
                            <p>‚Ä¢ <strong>HbA1c:</strong> Every 3-6 months</p>
                            <p>‚Ä¢ <strong>Lipid Profile:</strong> Annually (or as directed)</p>
                            <p>‚Ä¢ <strong>Kidney Function:</strong> Annually (CMP + Microalbuminuria)</p>
                            <p>‚Ä¢ <strong>Liver Function:</strong> Annually (if on certain medications)</p>
                        </div>
                    </div>
                    
                    <!-- Recent Lab Results -->
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-3">üìã Recent Lab Results</h3>
                        <div id="lab-results-list" class="space-y-4 max-h-96 overflow-y-auto">
                            <!-- Lab results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Medication Manager Tab -->
        <div id="med-manager-content" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Add New Medication -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üíä Add New Medication</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Medication Name</label>
                            <input type="text" id="new-med-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="e.g., Metformin, Lisinopril">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dosage</label>
                                <input type="text" id="new-med-dosage" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="500mg, 10mg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Frequency</label>
                                <select id="new-med-frequency" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="once-daily">Once Daily</option>
                                    <option value="twice-daily">Twice Daily</option>
                                    <option value="three-times">Three Times Daily</option>
                                    <option value="four-times">Four Times Daily</option>
                                    <option value="as-needed">As Needed</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Reminder Times</label>
                            <input type="text" id="new-med-times" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="08:00, 20:00 (for twice daily)">
                            <p class="text-xs text-gray-500 mt-1">Enter times separated by commas (24-hour format)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Medication Type</label>
                            <select id="new-med-type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="diabetes">Diabetes Medication</option>
                                <option value="blood-pressure">Blood Pressure</option>
                                <option value="cholesterol">Cholesterol</option>
                                <option value="heart">Heart Medication</option>
                                <option value="vitamin">Vitamin/Supplement</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Instructions/Notes</label>
                            <textarea id="new-med-notes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" rows="3" placeholder="Take with food, side effects to watch for, etc."></textarea>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="new-med-active" checked class="mr-2">
                            <label for="new-med-active" class="text-sm text-gray-700">Active medication (enable reminders)</label>
                        </div>
                        <button onclick="addNewMedication()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            Add Medication & Set Reminders
                        </button>
                    </div>
                </div>

                <!-- Current Medications List -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìã Current Medications</h2>
                    <div id="current-medications-list" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- Current medications will be populated here -->
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-3">Quick Actions</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="toggleAllMedications(false)" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                                Pause All Reminders
                            </button>
                            <button onclick="toggleAllMedications(true)" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                                Resume All Reminders
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Data Tab -->
        <div id="export-content" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Export Options -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üì§ Export Your Health Data</h2>
                    <p class="text-gray-600 mb-6">Download your diabetes tracking data to share with healthcare providers or for personal analysis.</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Range</label>
                            <select id="export-range" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="7">Last 7 days</option>
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 3 months</option>
                                <option value="180">Last 6 months</option>
                                <option value="365">Last year</option>
                                <option value="all">All data</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Types to Include</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="export-glucose" checked class="mr-2">
                                    <span>Blood Glucose Readings</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="export-insulin" checked class="mr-2">
                                    <span>Insulin Doses</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="export-medication" checked class="mr-2">
                                    <span>Medications</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="export-food" checked class="mr-2">
                                    <span>Food & Carbohydrates</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="export-exercise" checked class="mr-2">
                                    <span>Exercise Activities</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="export-vitals" checked class="mr-2">
                                    <span>Vital Signs (Weight, BP)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="export-hba1c" checked class="mr-2">
                                    <span>HbA1c Results</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="exportData('csv')" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                                üìä Export as CSV
                            </button>
                            <button onclick="exportData('pdf')" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                                üìÑ Export as PDF
                            </button>
                        </div>
                        
                        <button onclick="exportData('json')" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            üíæ Export as JSON (Complete Backup)
                        </button>
                    </div>
                </div>

                <!-- Export History & Tips -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìã Export Tips & History</h2>
                    
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-3">üí° Export Tips</h3>
                        <ul class="text-sm text-blue-700 space-y-2">
                            <li>‚Ä¢ <strong>CSV format</strong> - Best for spreadsheet analysis (Excel, Google Sheets)</li>
                            <li>‚Ä¢ <strong>PDF format</strong> - Perfect for sharing with doctors and printing</li>
                            <li>‚Ä¢ <strong>JSON format</strong> - Complete backup of all your data</li>
                            <li>‚Ä¢ Export regularly to keep backups of your health data</li>
                            <li>‚Ä¢ Share recent data with your healthcare team before appointments</li>
                        </ul>
                    </div>
                    
                    <div class="mb-6 p-4 bg-green-50 rounded-lg">
                        <h3 class="font-semibold text-green-800 mb-3">üè• For Healthcare Providers</h3>
                        <p class="text-sm text-green-700">Your exported data includes timestamps, trends, and patterns that help your healthcare team make informed decisions about your diabetes management.</p>
                    </div>
                    
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-3">üìä Data Summary</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Glucose Readings:</span>
                                <span id="export-glucose-count" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Insulin Doses:</span>
                                <span id="export-insulin-count" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Food Entries:</span>
                                <span id="export-food-count" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Exercise Sessions:</span>
                                <span id="export-exercise-count" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>HbA1c Results:</span>
                                <span id="export-hba1c-count" class="font-semibold">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Health Summary Tab -->
        <div id="health-summary-content" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-8 max-w-4xl mx-auto">
                <!-- Header -->
                <div class="text-center mb-8 border-b pb-6">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">ü©∫ Comprehensive Health Summary</h1>
                    <p class="text-gray-600">Complete diabetes and health tracking report</p>
                    <div class="mt-4 flex justify-center gap-4">
                        <button onclick="printHealthSummary()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold">
                            üñ®Ô∏è Print Report
                        </button>
                        <button onclick="exportHealthSummaryPDF()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold">
                            üìÑ Save as PDF
                        </button>
                    </div>
                </div>

                <!-- Patient Information -->
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-blue-500 pl-4">Patient Information</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Age</p>
                            <p class="font-semibold" id="summary-age">--</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Sex</p>
                            <p class="font-semibold" id="summary-sex">--</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Height</p>
                            <p class="font-semibold" id="summary-height">--</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Diabetes Type</p>
                            <p class="font-semibold" id="summary-diabetes-type">--</p>
                        </div>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-green-500 pl-4">Current Key Metrics</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-400">
                            <p class="text-sm text-red-600">Latest HbA1c</p>
                            <p class="text-2xl font-bold text-red-800" id="summary-hba1c">--</p>
                            <p class="text-xs text-red-500" id="summary-hba1c-date">--</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400">
                            <p class="text-sm text-blue-600">Avg Glucose (7 days)</p>
                            <p class="text-2xl font-bold text-blue-800" id="summary-avg-glucose">--</p>
                            <p class="text-xs text-blue-500" id="summary-glucose-readings">-- readings</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-400">
                            <p class="text-sm text-purple-600">Current Weight</p>
                            <p class="text-2xl font-bold text-purple-800" id="summary-weight">--</p>
                            <p class="text-xs text-purple-500">BMI: <span id="summary-bmi">--</span></p>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-400">
                            <p class="text-sm text-orange-600">Latest Blood Pressure</p>
                            <p class="text-2xl font-bold text-orange-800" id="summary-bp">--</p>
                            <p class="text-xs text-orange-500" id="summary-bp-date">--</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Lab Results -->
                <div class="mb-8" id="lab-results-section">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-purple-500 pl-4">Recent Lab Results</h2>
                    <div id="summary-lab-results" class="space-y-4">
                        <!-- Lab results will be populated here -->
                    </div>
                </div>

                <!-- Glucose Trends -->
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-red-500 pl-4">Blood Glucose Trends (Last 30 Days)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-green-600">In Range (70-180 mg/dL)</p>
                            <p class="text-2xl font-bold text-green-800" id="glucose-in-range">--%</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <p class="text-sm text-yellow-600">Below Range (&lt;70 mg/dL)</p>
                            <p class="text-2xl font-bold text-yellow-800" id="glucose-low">--%</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <p class="text-sm text-red-600">Above Range (&gt;180 mg/dL)</p>
                            <p class="text-2xl font-bold text-red-800" id="glucose-high">--%</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Recent Glucose Readings</h3>
                        <div id="summary-glucose-list" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- Recent glucose readings will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Current Medications -->
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-blue-500 pl-4">Current Medications</h2>
                    <div id="summary-medications" class="space-y-2">
                        <!-- Medications will be populated here -->
                    </div>
                </div>

                <!-- Lifestyle Tracking -->
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-green-500 pl-4">Lifestyle Tracking (Last 30 Days)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">Exercise Summary</h3>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <p class="text-sm text-green-600">Total Exercise Sessions</p>
                                <p class="text-xl font-bold text-green-800" id="summary-exercise-count">--</p>
                                <p class="text-sm text-green-600 mt-1">Total Minutes: <span id="summary-exercise-minutes" class="font-semibold">--</span></p>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">Nutrition Tracking</h3>
                            <div class="bg-orange-50 p-4 rounded-lg">
                                <p class="text-sm text-orange-600">Food Entries Logged</p>
                                <p class="text-xl font-bold text-orange-800" id="summary-food-count">--</p>
                                <p class="text-sm text-orange-600 mt-1">Avg Daily Carbs: <span id="summary-avg-carbs" class="font-semibold">--g</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Appointments -->
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-yellow-500 pl-4">Upcoming Appointments</h2>
                    <div id="summary-appointments" class="space-y-2">
                        <!-- Appointments will be populated here -->
                    </div>
                </div>

                <!-- Footer -->
                <div class="text-center text-sm text-gray-500 border-t pt-4">
                    <p>Generated by DiabetesTracker Pro on <span id="report-date"></span></p>
                    <p>This report is for informational purposes and should be shared with your healthcare provider.</p>
                </div>
            </div>
        </div>

        <!-- Appointments Tab -->
        <div id="appointments-content" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Add Appointment -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìÖ Schedule Follow-up Appointment</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Appointment Type</label>
                            <select id="appointment-type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="endocrinologist">Endocrinologist</option>
                                <option value="primary-care">Primary Care Doctor</option>
                                <option value="ophthalmologist">Eye Doctor (Ophthalmologist)</option>
                                <option value="podiatrist">Foot Doctor (Podiatrist)</option>
                                <option value="dentist">Dentist</option>
                                <option value="nutritionist">Nutritionist/Dietitian</option>
                                <option value="lab-work">Lab Work</option>
                                <option value="other">Other Specialist</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                <input type="date" id="appointment-date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                                <input type="time" id="appointment-time" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Doctor/Clinic Name</label>
                            <input type="text" id="appointment-doctor" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Dr. Smith or ABC Medical Center">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location/Address</label>
                            <textarea id="appointment-location" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="2" placeholder="123 Medical Drive, Suite 100"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Purpose/Notes</label>
                            <textarea id="appointment-notes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Routine check-up, discuss medication changes, review lab results, etc."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Reminder</label>
                            <select id="appointment-reminder" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="1-day">1 Day Before</option>
                                <option value="2-days">2 Days Before</option>
                                <option value="1-week">1 Week Before</option>
                                <option value="none">No Reminder</option>
                            </select>
                        </div>
                        <button onclick="addAppointment()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            Schedule Appointment
                        </button>
                    </div>
                </div>

                <!-- Upcoming Appointments -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìã Upcoming Appointments</h2>
                    <div id="appointments-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Appointments will be populated here -->
                    </div>

                    <!-- Appointment Preparation Checklist -->
                    <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                        <h3 class="font-semibold text-yellow-800 mb-3">üìù Appointment Preparation</h3>
                        <div class="text-sm text-yellow-700 space-y-1">
                            <div class="flex items-center">
                                <input type="checkbox" class="mr-2"> Bring current medications list
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" class="mr-2"> Print recent glucose readings
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" class="mr-2"> Prepare questions to ask
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" class="mr-2"> Bring insurance card & ID
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" class="mr-2"> Review recent symptoms/concerns
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let diabetesType = localStorage.getItem('diabetesType') || null;
        let glucoseReadings = JSON.parse(localStorage.getItem('glucoseReadings')) || [];
        let insulinDoses = JSON.parse(localStorage.getItem('insulinDoses')) || [];
        let medications = JSON.parse(localStorage.getItem('medications')) || [];
        let medicationSchedule = JSON.parse(localStorage.getItem('medicationSchedule')) || [];
        let foodItems = JSON.parse(localStorage.getItem('foodItems')) || [];
        let exercises = JSON.parse(localStorage.getItem('exercises')) || [];
        let weightEntries = JSON.parse(localStorage.getItem('weightEntries')) || [];
        let bloodPressureReadings = JSON.parse(localStorage.getItem('bloodPressureReadings')) || [];
        let hba1cReadings = JSON.parse(localStorage.getItem('hba1cReadings')) || [];
        let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
        let userProfile = JSON.parse(localStorage.getItem('userProfile')) || { height: null, age: null, sex: null };
        let currentLanguage = localStorage.getItem('currentLanguage') || 'en';
        
        // New data for gamification and features
        let userPoints = parseInt(localStorage.getItem('userPoints')) || 0;
        let userLevel = parseInt(localStorage.getItem('userLevel')) || 1;
        let streakDays = parseInt(localStorage.getItem('streakDays')) || 0;
        let lastActivityDate = localStorage.getItem('lastActivityDate') || null;
        let achievements = JSON.parse(localStorage.getItem('achievements')) || [];
        let messages = JSON.parse(localStorage.getItem('messages')) || [];
        let hba1cGoal = parseFloat(localStorage.getItem('hba1cGoal')) || 7.0;
        let labResults = JSON.parse(localStorage.getItem('labResults')) || [];

        // Translation data
        const translations = {
            en: {
                app_title: "DiabetesTracker Pro",
                app_subtitle: "Complete diabetes health monitoring system",
                diabetes: "Diabetes",
                age: "Age",
                height: "Height",
                edit_profile: "Edit Profile",
                test_alarm: "Test Alarm",
                avg_glucose: "Avg Glucose",
                current_weight: "Current Weight",
                blood_pressure: "Blood Pressure",
                bmi: "BMI",
                blood_glucose_tab: "ü©∏ Blood Glucose",
                insulin_tab: "üíâ Insulin",
                medication_tab: "üíä Medications",
                food_tab: "üçé Food & Carbs",
                exercise_tab: "üèÉ Exercise",
                vitals_tab: "üìä Vitals",
                appointments_tab: "üìÖ Appointments",
                male: "Male",
                female: "Female"
            },
            ar: {
                app_title: "ŸÖÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ≥ŸÉÿ±Ÿä ÿßŸÑŸÖÿ≠ÿ™ÿ±ŸÅ",
                app_subtitle: "ŸÜÿ∏ÿßŸÖ ŸÖÿ±ÿßŸÇÿ®ÿ© ÿµÿ≠ÿ© ÿßŸÑÿ≥ŸÉÿ±Ÿä ÿßŸÑÿ¥ÿßŸÖŸÑ",
                diabetes: "ÿßŸÑÿ≥ŸÉÿ±Ÿä",
                age: "ÿßŸÑÿπŸÖÿ±",
                height: "ÿßŸÑÿ∑ŸàŸÑ",
                edit_profile: "ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä",
                test_alarm: "ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑŸÖŸÜÿ®Ÿá",
                avg_glucose: "ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ¨ŸÑŸàŸÉŸàÿ≤",
                current_weight: "ÿßŸÑŸàÿ≤ŸÜ ÿßŸÑÿ≠ÿßŸÑŸä",
                blood_pressure: "ÿ∂ÿ∫ÿ∑ ÿßŸÑÿØŸÖ",
                bmi: "ŸÖÿ§ÿ¥ÿ± ŸÉÿ™ŸÑÿ© ÿßŸÑÿ¨ÿ≥ŸÖ",
                blood_glucose_tab: "ü©∏ ÿ¨ŸÑŸàŸÉŸàÿ≤ ÿßŸÑÿØŸÖ",
                insulin_tab: "üíâ ÿßŸÑÿ£ŸÜÿ≥ŸàŸÑŸäŸÜ",
                medication_tab: "üíä ÿßŸÑÿ£ÿØŸàŸäÿ©",
                food_tab: "üçé ÿßŸÑÿ∑ÿπÿßŸÖ ŸàÿßŸÑŸÉÿ±ÿ®ŸàŸáŸäÿØÿ±ÿßÿ™",
                exercise_tab: "üèÉ ÿßŸÑÿ™ŸÖÿßÿ±ŸäŸÜ",
                vitals_tab: "üìä ÿßŸÑÿπŸÑÿßŸÖÿßÿ™ ÿßŸÑÿ≠ŸäŸàŸäÿ©",
                appointments_tab: "üìÖ ÿßŸÑŸÖŸàÿßÿπŸäÿØ",
                male: "ÿ∞ŸÉÿ±",
                female: "ÿ£ŸÜÿ´Ÿâ"
            },
            es: {
                app_title: "DiabetesTracker Pro",
                app_subtitle: "Sistema completo de monitoreo de salud para diabetes",
                diabetes: "Diabetes",
                age: "Edad",
                height: "Altura",
                edit_profile: "Editar Perfil",
                test_alarm: "Probar Alarma",
                avg_glucose: "Glucosa Promedio",
                current_weight: "Peso Actual",
                blood_pressure: "Presi√≥n Arterial",
                bmi: "IMC",
                blood_glucose_tab: "ü©∏ Glucosa en Sangre",
                insulin_tab: "üíâ Insulina",
                medication_tab: "üíä Medicamentos",
                food_tab: "üçé Comida y Carbohidratos",
                exercise_tab: "üèÉ Ejercicio",
                vitals_tab: "üìä Signos Vitales",
                appointments_tab: "üìÖ Citas",
                male: "Masculino",
                female: "Femenino"
            }
        };

        // Reminder and alarm system
        let reminderTimeouts = [];
        let appointmentTimeouts = [];
        let alarmInterval = null;
        let currentReminderType = null;

        // Language functions
        function changeLanguage() {
            const selectedLanguage = document.getElementById('language-selector').value;
            currentLanguage = selectedLanguage;
            localStorage.setItem('currentLanguage', currentLanguage);
            
            // Apply RTL for Arabic
            if (currentLanguage === 'ar') {
                document.body.setAttribute('dir', 'rtl');
                document.documentElement.setAttribute('lang', 'ar');
            } else {
                document.body.setAttribute('dir', 'ltr');
                document.documentElement.setAttribute('lang', currentLanguage);
            }
            
            updateTranslations();
        }

        function updateTranslations() {
            const currentTranslations = translations[currentLanguage];
            
            // Update main title and subtitle
            document.querySelector('h1').textContent = `ü©∫ ${currentTranslations.app_title}`;
            const subtitleElements = document.querySelectorAll('p.text-gray-600');
            if (subtitleElements.length > 0) {
                subtitleElements[0].textContent = currentTranslations.app_subtitle;
            }
            
            // Update all elements with data-translate attribute
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (currentTranslations[key]) {
                    element.textContent = currentTranslations[key];
                }
            });
            
            // Update tab buttons
            document.getElementById('glucose-tab').innerHTML = currentTranslations.blood_glucose_tab;
            document.getElementById('insulin-tab').innerHTML = currentTranslations.insulin_tab;
            document.getElementById('medication-tab').innerHTML = currentTranslations.medication_tab;
            document.getElementById('food-tab').innerHTML = currentTranslations.food_tab;
            document.getElementById('exercise-tab').innerHTML = currentTranslations.exercise_tab;
            document.getElementById('vitals-tab').innerHTML = currentTranslations.vitals_tab;
            document.getElementById('appointments-tab').innerHTML = currentTranslations.appointments_tab;
            
            updateProfileDisplay();
        }

        // Height unit toggle function
        function toggleHeightUnits() {
            const unit = document.getElementById('setup-height-unit').value;
            const imperialDiv = document.getElementById('height-imperial');
            const metricDiv = document.getElementById('height-metric');
            
            if (unit === 'metric') {
                imperialDiv.classList.add('hidden');
                metricDiv.classList.remove('hidden');
            } else {
                imperialDiv.classList.remove('hidden');
                metricDiv.classList.add('hidden');
            }
        }

        // Initialize app
        function initializeApp() {
            // Set language selector to saved language
            document.getElementById('language-selector').value = currentLanguage;
            
            // Apply language settings
            if (currentLanguage === 'ar') {
                document.body.setAttribute('dir', 'rtl');
                document.documentElement.setAttribute('lang', 'ar');
            } else {
                document.body.setAttribute('dir', 'ltr');
                document.documentElement.setAttribute('lang', currentLanguage);
            }
            
            updateTranslations();
            
            if (!diabetesType || !userProfile.age || !userProfile.sex || !userProfile.height) {
                document.getElementById('profile-setup-modal').classList.remove('hidden');
                
                // Pre-fill existing data if available
                if (userProfile.age) document.getElementById('setup-age').value = userProfile.age;
                if (userProfile.sex) document.getElementById('setup-sex').value = userProfile.sex;
                if (diabetesType) document.getElementById('setup-diabetes-type').value = diabetesType;
                if (userProfile.height) {
                    const heightUnit = userProfile.heightUnit || 'imperial';
                    document.getElementById('setup-height-unit').value = heightUnit;
                    
                    if (heightUnit === 'metric') {
                        const heightCm = Math.round(userProfile.height * 2.54);
                        document.getElementById('setup-height-cm').value = heightCm;
                        document.getElementById('height-imperial').classList.add('hidden');
                        document.getElementById('height-metric').classList.remove('hidden');
                    } else {
                        const feet = Math.floor(userProfile.height / 12);
                        const inches = userProfile.height % 12;
                        document.getElementById('setup-height-feet').value = feet;
                        document.getElementById('setup-height-inches').value = inches;
                    }
                }
            } else {
                updateProfileDisplay();
                document.getElementById('profile-display').classList.remove('hidden');
                document.getElementById('profile-setup-modal').classList.add('hidden');
            }
            
            // Set today's date for weight entry
            const weightDateInput = document.getElementById('weight-date');
            if (weightDateInput) {
                weightDateInput.value = new Date().toISOString().split('T')[0];
            }
            
            updateAllDisplays();
            scheduleAllReminders();
            
            // Ensure medication manager tab is properly initialized
            updateCurrentMedicationsList();
        }

        // Profile setup functions
        function completeProfileSetup() {
            const age = parseInt(document.getElementById('setup-age').value);
            const sex = document.getElementById('setup-sex').value;
            const heightUnit = document.getElementById('setup-height-unit').value;
            const diabetesTypeValue = document.getElementById('setup-diabetes-type').value;
            
            let heightInInches;
            
            if (heightUnit === 'metric') {
                const heightCm = parseInt(document.getElementById('setup-height-cm').value);
                if (!heightCm || heightCm < 100 || heightCm > 250) {
                    alert('Please enter a valid height between 100-250 cm.');
                    return;
                }
                // Convert cm to inches for internal storage
                heightInInches = Math.round(heightCm / 2.54);
            } else {
                const feet = parseInt(document.getElementById('setup-height-feet').value);
                const inches = parseInt(document.getElementById('setup-height-inches').value);
                
                if (!feet || (inches === '' || inches < 0) || inches > 11) {
                    alert('Please enter valid height. Inches must be between 0 and 11.');
                    return;
                }
                heightInInches = (feet * 12) + inches;
            }
            
            if (!age || !sex || !diabetesTypeValue) {
                alert('Please fill in all fields to complete your profile setup.');
                return;
            }
            
            // Save profile data
            userProfile.age = age;
            userProfile.sex = sex;
            userProfile.height = heightInInches;
            userProfile.heightUnit = heightUnit;
            diabetesType = diabetesTypeValue;
            
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            localStorage.setItem('diabetesType', diabetesType);
            
            // Update display
            updateProfileDisplay();
            document.getElementById('profile-display').classList.remove('hidden');
            document.getElementById('profile-setup-modal').classList.add('hidden');
            
            showSuccessMessage('Profile setup complete! You can now start tracking your health data.');
        }

        function updateProfileDisplay() {
            const currentTranslations = translations[currentLanguage];
            
            if (diabetesType) {
                document.getElementById('current-diabetes-type').textContent = diabetesType;
            }
            if (userProfile.age) {
                document.getElementById('current-age').textContent = userProfile.age;
            }
            if (userProfile.sex) {
                const sexTranslated = currentTranslations[userProfile.sex] || userProfile.sex;
                document.getElementById('current-sex').textContent = sexTranslated;
            }
            if (userProfile.height) {
                if (userProfile.heightUnit === 'metric') {
                    const heightCm = Math.round(userProfile.height * 2.54);
                    document.getElementById('current-height').textContent = `${heightCm} cm`;
                } else {
                    const feet = Math.floor(userProfile.height / 12);
                    const inches = userProfile.height % 12;
                    document.getElementById('current-height').textContent = `${feet}'${inches}"`;
                }
            }
        }

        function editProfile() {
            // Pre-fill the setup form with current data
            if (userProfile.age) document.getElementById('setup-age').value = userProfile.age;
            if (userProfile.sex) document.getElementById('setup-sex').value = userProfile.sex;
            if (diabetesType) document.getElementById('setup-diabetes-type').value = diabetesType;
            
            if (userProfile.height) {
                const heightUnit = userProfile.heightUnit || 'imperial';
                document.getElementById('setup-height-unit').value = heightUnit;
                
                if (heightUnit === 'metric') {
                    const heightCm = Math.round(userProfile.height * 2.54);
                    document.getElementById('setup-height-cm').value = heightCm;
                    document.getElementById('height-imperial').classList.add('hidden');
                    document.getElementById('height-metric').classList.remove('hidden');
                } else {
                    const feet = Math.floor(userProfile.height / 12);
                    const inches = userProfile.height % 12;
                    document.getElementById('setup-height-feet').value = feet;
                    document.getElementById('setup-height-inches').value = inches;
                    document.getElementById('height-imperial').classList.remove('hidden');
                    document.getElementById('height-metric').classList.add('hidden');
                }
            }
            
            document.getElementById('profile-setup-modal').classList.remove('hidden');
        }

        // Diabetes type selection
        function selectDiabetesType(type) {
            diabetesType = type;
            localStorage.setItem('diabetesType', type);
            
            updateProfileDisplay();
            document.getElementById('diabetes-type-modal').classList.add('hidden');
            
            showSuccessMessage(`Diabetes type changed to ${type}!`);
        }

        function showDiabetesTypeModal() {
            document.getElementById('diabetes-type-modal').classList.remove('hidden');
        }

        // Tab functionality
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            document.getElementById(tabName + '-content').classList.remove('hidden');
            
            const activeTab = document.getElementById(tabName + '-tab');
            activeTab.classList.remove('bg-gray-200', 'text-gray-700');
            activeTab.classList.add('bg-blue-500', 'text-white');
        }

        // Glucose functions
        function addGlucoseReading() {
            const level = document.getElementById('glucose-level').value;
            const time = document.getElementById('glucose-time').value;
            const notes = document.getElementById('glucose-notes').value;
            
            if (!level) {
                alert('Please enter a glucose level');
                return;
            }
            
            const reading = {
                id: Date.now(),
                level: parseInt(level),
                time: time,
                date: new Date(),
                notes: notes
            };
            
            glucoseReadings.unshift(reading);
            localStorage.setItem('glucoseReadings', JSON.stringify(glucoseReadings));
            updateGlucoseList();
            updateQuickStats();
            
            document.getElementById('glucose-level').value = '';
            document.getElementById('glucose-notes').value = '';
            
            showSuccessMessage('Glucose reading added successfully!');
            awardPoints(10, 'logging glucose');
        }

        function updateGlucoseList() {
            const list = document.getElementById('glucose-list');
            list.innerHTML = '';
            
            if (glucoseReadings.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">No glucose readings yet. Add your first reading!</p>';
                return;
            }
            
            glucoseReadings.slice(0, 10).forEach(reading => {
                const status = getGlucoseStatus(reading.level, reading.time);
                const div = document.createElement('div');
                div.className = `${status.bgColor} border-l-4 ${status.borderColor} p-4 rounded`;
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold ${status.textColor}">${reading.level} mg/dL</p>
                            <p class="text-sm ${status.textColor.replace('800', '600')}">${reading.time.replace('-', ' ')} ‚Ä¢ ${formatDate(reading.date)}</p>
                            ${reading.notes ? `<p class="text-sm ${status.textColor.replace('800', '500')} mt-1">${reading.notes}</p>` : ''}
                        </div>
                        <span class="${status.textColor.replace('800', '600')} font-bold">${status.label}</span>
                    </div>
                `;
                
                list.appendChild(div);
            });
        }

        function getGlucoseStatus(level, time) {
            let normal = false;
            
            if (time.includes('fasting') || time.includes('before')) {
                normal = level >= 70 && level <= 130;
            } else if (time.includes('after')) {
                normal = level < 180;
            } else if (time.includes('bedtime')) {
                normal = level >= 100 && level <= 140;
            }
            
            if (normal) {
                return {
                    label: '‚úì Normal',
                    bgColor: 'bg-green-50',
                    borderColor: 'border-green-400',
                    textColor: 'text-green-800'
                };
            } else if (level < 70) {
                return {
                    label: '‚ö† Low',
                    bgColor: 'bg-yellow-50',
                    borderColor: 'border-yellow-400',
                    textColor: 'text-yellow-800'
                };
            } else {
                return {
                    label: '‚ö† High',
                    bgColor: 'bg-red-50',
                    borderColor: 'border-red-400',
                    textColor: 'text-red-800'
                };
            }
        }

        // Insulin functions
        function addInsulinDose() {
            const type = document.getElementById('insulin-type').value;
            const dose = parseFloat(document.getElementById('insulin-dose').value);
            const site = document.getElementById('insulin-site').value;
            const reason = document.getElementById('insulin-reason').value;
            const bgBefore = document.getElementById('insulin-bg-before').value;
            const notes = document.getElementById('insulin-notes').value;
            
            if (!dose) {
                alert('Please enter insulin dosage');
                return;
            }
            
            const insulinDose = {
                id: Date.now(),
                type: type,
                dose: dose,
                site: site,
                reason: reason,
                bgBefore: bgBefore ? parseInt(bgBefore) : null,
                notes: notes,
                date: new Date()
            };
            
            insulinDoses.unshift(insulinDose);
            localStorage.setItem('insulinDoses', JSON.stringify(insulinDoses));
            updateInsulinList();
            
            // Clear form
            document.getElementById('insulin-dose').value = '';
            document.getElementById('insulin-bg-before').value = '';
            document.getElementById('insulin-notes').value = '';
            
            showSuccessMessage('Insulin dose logged successfully!');
            awardPoints(8, 'logging insulin');
        }

        function updateInsulinList() {
            const list = document.getElementById('insulin-list');
            list.innerHTML = '';
            
            if (insulinDoses.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">No insulin doses logged yet.</p>';
                return;
            }
            
            insulinDoses.slice(0, 10).forEach(dose => {
                const div = document.createElement('div');
                div.className = 'bg-blue-50 border-l-4 border-blue-400 p-4 rounded';
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-blue-800">${dose.dose} units - ${dose.type.replace('-', ' ')}</p>
                            <p class="text-sm text-blue-600">${formatDate(dose.date)} ‚Ä¢ ${dose.site} ‚Ä¢ ${dose.reason.replace('-', ' ')}</p>
                            ${dose.bgBefore ? `<p class="text-sm text-blue-500">BG Before: ${dose.bgBefore} mg/dL</p>` : ''}
                            ${dose.notes ? `<p class="text-sm text-blue-500 mt-1">${dose.notes}</p>` : ''}
                        </div>
                        <span class="text-blue-600 font-bold">üíâ</span>
                    </div>
                `;
                
                list.appendChild(div);
            });
        }

        // Medication functions
        function addMedication() {
            const name = document.getElementById('med-name').value;
            const dosage = document.getElementById('med-dosage').value;
            const frequency = document.getElementById('med-frequency').value;
            const times = document.getElementById('med-times').value;
            const notes = document.getElementById('med-notes').value;
            
            if (!name || !dosage) {
                alert('Please enter medication name and dosage');
                return;
            }
            
            const medication = {
                id: Date.now(),
                name: name,
                dosage: dosage,
                frequency: frequency,
                times: times.split(',').map(t => t.trim()).filter(t => t),
                notes: notes,
                active: true,
                dateAdded: new Date()
            };
            
            medications.push(medication);
            localStorage.setItem('medications', JSON.stringify(medications));
            
            // Create medication schedule entries
            if (medication.times.length > 0) {
                medication.times.forEach(time => {
                    const scheduleEntry = {
                        id: Date.now() + Math.random(),
                        medicationId: medication.id,
                        name: medication.name,
                        dosage: medication.dosage,
                        time: time,
                        taken: false,
                        date: new Date().toDateString()
                    };
                    medicationSchedule.push(scheduleEntry);
                });
                localStorage.setItem('medicationSchedule', JSON.stringify(medicationSchedule));
            }
            
            updateMedicationDisplays();
            scheduleAllReminders();
            
            // Clear form
            document.getElementById('med-name').value = '';
            document.getElementById('med-dosage').value = '';
            document.getElementById('med-times').value = '';
            document.getElementById('med-notes').value = '';
            
            showSuccessMessage('Medication added with reminders set!');
        }

        // New Medication Manager Functions
        function addNewMedication() {
            const name = document.getElementById('new-med-name').value.trim();
            const dosage = document.getElementById('new-med-dosage').value.trim();
            const frequency = document.getElementById('new-med-frequency').value;
            const times = document.getElementById('new-med-times').value.trim();
            const type = document.getElementById('new-med-type').value;
            const notes = document.getElementById('new-med-notes').value.trim();
            const active = document.getElementById('new-med-active').checked;
            
            if (!name || !dosage) {
                alert('Please enter medication name and dosage');
                return;
            }
            
            const medication = {
                id: Date.now(),
                name: name,
                dosage: dosage,
                frequency: frequency,
                times: times ? times.split(',').map(t => t.trim()).filter(t => t) : [],
                type: type,
                notes: notes,
                active: active,
                dateAdded: new Date()
            };
            
            medications.push(medication);
            localStorage.setItem('medications', JSON.stringify(medications));
            
            // Create medication schedule entries if active
            if (active && medication.times.length > 0) {
                createMedicationSchedule(medication);
            }
            
            updateCurrentMedicationsList();
            updateMedicationDisplays();
            scheduleAllReminders();
            
            // Clear form
            clearNewMedicationForm();
            
            showSuccessMessage(`${name} added successfully with ${active ? 'active' : 'inactive'} reminders!`);
            awardPoints(10, 'adding medication');
        }

        function clearNewMedicationForm() {
            document.getElementById('new-med-name').value = '';
            document.getElementById('new-med-dosage').value = '';
            document.getElementById('new-med-times').value = '';
            document.getElementById('new-med-notes').value = '';
            document.getElementById('new-med-active').checked = true;
        }

        function createMedicationSchedule(medication) {
            // Remove old schedule entries for this medication
            medicationSchedule = medicationSchedule.filter(entry => entry.medicationId !== medication.id);
            
            // Create new schedule entries
            medication.times.forEach(time => {
                const scheduleEntry = {
                    id: Date.now() + Math.random(),
                    medicationId: medication.id,
                    name: medication.name,
                    dosage: medication.dosage,
                    time: time,
                    taken: false,
                    date: new Date().toDateString()
                };
                medicationSchedule.push(scheduleEntry);
            });
            localStorage.setItem('medicationSchedule', JSON.stringify(medicationSchedule));
        }

        function updateCurrentMedicationsList() {
            const list = document.getElementById('current-medications-list');
            if (!list) {
                console.error('Current medications list element not found');
                return;
            }
            
            list.innerHTML = '';
            
            if (medications.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">No medications added yet. Add your first medication above!</p>';
                return;
            }
            
            medications.forEach(med => {
                const div = document.createElement('div');
                const statusClass = med.active ? 'bg-green-50 border-green-400' : 'bg-gray-50 border-gray-400';
                const statusIcon = med.active ? '‚úÖ' : '‚è∏Ô∏è';
                const typeColors = {
                    'diabetes': 'bg-red-100 text-red-800',
                    'blood-pressure': 'bg-blue-100 text-blue-800',
                    'cholesterol': 'bg-yellow-100 text-yellow-800',
                    'heart': 'bg-pink-100 text-pink-800',
                    'vitamin': 'bg-green-100 text-green-800',
                    'other': 'bg-gray-100 text-gray-800'
                };
                
                div.className = `${statusClass} border-l-4 p-4 rounded-lg mb-4`;
                
                const timesDisplay = med.times && med.times.length > 0 ? med.times.join(', ') : 'No times set';
                const typeDisplay = med.type ? med.type.replace('-', ' ') : 'other';
                
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-gray-800">${med.name} ${med.dosage}</h3>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${typeColors[med.type] || typeColors.other}">
                                    ${typeDisplay}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600">${med.frequency.replace('-', ' ')} ‚Ä¢ Times: ${timesDisplay}</p>
                            ${med.notes ? `<p class="text-sm text-gray-500 mt-1">${med.notes}</p>` : ''}
                            <p class="text-xs text-gray-400 mt-1">Added: ${new Date(med.dateAdded).toLocaleDateString()}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${statusIcon}</span>
                            <div class="flex flex-col gap-1">
                                <button onclick="toggleMedication(${med.id})" class="text-xs px-2 py-1 rounded ${med.active ? 'bg-orange-500 hover:bg-orange-600 text-white' : 'bg-green-500 hover:bg-green-600 text-white'}">
                                    ${med.active ? 'Pause' : 'Resume'}
                                </button>
                                <button onclick="editMedication(${med.id})" class="text-xs px-2 py-1 rounded bg-blue-500 hover:bg-blue-600 text-white">
                                    Edit
                                </button>
                                <button onclick="deleteMedication(${med.id})" class="text-xs px-2 py-1 rounded bg-red-500 hover:bg-red-600 text-white">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function toggleMedication(medicationId) {
            const medication = medications.find(med => med.id === medicationId);
            if (medication) {
                medication.active = !medication.active;
                localStorage.setItem('medications', JSON.stringify(medications));
                
                if (medication.active) {
                    // Reactivate - create schedule entries
                    createMedicationSchedule(medication);
                    showSuccessMessage(`${medication.name} reminders resumed!`);
                } else {
                    // Deactivate - remove schedule entries
                    medicationSchedule = medicationSchedule.filter(entry => entry.medicationId !== medicationId);
                    localStorage.setItem('medicationSchedule', JSON.stringify(medicationSchedule));
                    showSuccessMessage(`${medication.name} reminders paused!`);
                }
                
                updateCurrentMedicationsList();
                updateMedicationDisplays();
                scheduleAllReminders();
            }
        }

        function editMedication(medicationId) {
            const medication = medications.find(med => med.id === medicationId);
            if (medication) {
                // Pre-fill the form with current medication data
                document.getElementById('new-med-name').value = medication.name;
                document.getElementById('new-med-dosage').value = medication.dosage;
                document.getElementById('new-med-frequency').value = medication.frequency;
                document.getElementById('new-med-times').value = medication.times.join(', ');
                document.getElementById('new-med-type').value = medication.type || 'other';
                document.getElementById('new-med-notes').value = medication.notes || '';
                document.getElementById('new-med-active').checked = medication.active;
                
                // Delete the old medication
                deleteMedication(medicationId, false);
                
                showSuccessMessage(`${medication.name} loaded for editing. Update the details and click "Add Medication" to save changes.`);
            }
        }

        function deleteMedication(medicationId, showConfirm = true) {
            console.log('Attempting to delete medication with ID:', medicationId);
            console.log('Current medications:', medications);
            
            const medication = medications.find(med => med.id == medicationId); // Use == for loose comparison
            if (!medication) {
                console.error('Medication not found with ID:', medicationId);
                console.log('Available medication IDs:', medications.map(m => m.id));
                alert('Error: Medication not found. Please refresh the page and try again.');
                return;
            }
            
            if (showConfirm && !confirm(`Are you sure you want to delete ${medication.name}? This will remove all reminders and cannot be undone.`)) {
                return;
            }
            
            console.log('Deleting medication:', medication.name);
            
            // Remove medication from array
            const originalLength = medications.length;
            medications = medications.filter(med => med.id != medicationId); // Use != for loose comparison
            console.log(`Medications array length: ${originalLength} -> ${medications.length}`);
            localStorage.setItem('medications', JSON.stringify(medications));
            
            // Remove all schedule entries for this medication
            const originalScheduleLength = medicationSchedule.length;
            medicationSchedule = medicationSchedule.filter(entry => entry.medicationId != medicationId); // Use != for loose comparison
            console.log(`Schedule entries: ${originalScheduleLength} -> ${medicationSchedule.length}`);
            localStorage.setItem('medicationSchedule', JSON.stringify(medicationSchedule));
            
            // Update all displays
            updateCurrentMedicationsList();
            updateMedicationDisplays();
            scheduleAllReminders();
            
            if (showConfirm) {
                showSuccessMessage(`${medication.name} deleted successfully!`);
            }
            
            console.log('Medication deletion completed');
        }

        function toggleAllMedications(activate) {
            medications.forEach(med => {
                med.active = activate;
                if (activate) {
                    createMedicationSchedule(med);
                } else {
                    medicationSchedule = medicationSchedule.filter(entry => entry.medicationId !== med.id);
                }
            });
            
            localStorage.setItem('medications', JSON.stringify(medications));
            localStorage.setItem('medicationSchedule', JSON.stringify(medicationSchedule));
            
            updateCurrentMedicationsList();
            updateMedicationDisplays();
            scheduleAllReminders();
            
            showSuccessMessage(`All medication reminders ${activate ? 'resumed' : 'paused'}!`);
        }

        function updateMedicationDisplays() {
            updateMedicationSchedule();
            updateMedicationList();
        }

        function updateMedicationSchedule() {
            const schedule = document.getElementById('medication-schedule');
            schedule.innerHTML = '';
            
            const today = new Date().toDateString();
            const todaySchedule = medicationSchedule.filter(entry => entry.date === today);
            
            if (todaySchedule.length === 0) {
                schedule.innerHTML = '<p class="text-gray-500 text-center py-4">No medications scheduled for today.</p>';
                return;
            }
            
            todaySchedule.forEach(entry => {
                const div = document.createElement('div');
                const statusClass = entry.taken ? 'bg-green-50 border-green-400' : 'bg-yellow-50 border-yellow-400';
                const statusIcon = entry.taken ? '‚úÖ' : '‚è∞';
                
                div.className = `${statusClass} border-l-4 p-4 rounded`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${entry.name} ${entry.dosage}</p>
                            <p class="text-sm text-gray-600">${entry.time}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="markMedicationTaken(${entry.id})" class="text-2xl">${statusIcon}</button>
                            <button onclick="deleteMedicationFromSchedule(${entry.id})" class="text-red-500 hover:text-red-700 text-sm px-2 py-1 rounded bg-red-100 hover:bg-red-200">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
                
                schedule.appendChild(div);
            });
        }

        function updateMedicationList() {
            const list = document.getElementById('medication-list');
            list.innerHTML = '';
            
            if (medications.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">No medications added yet.</p>';
                return;
            }
            
            medications.slice(0, 5).forEach(med => {
                const div = document.createElement('div');
                div.className = 'bg-purple-50 border-l-4 border-purple-400 p-4 rounded';
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-purple-800">${med.name} ${med.dosage}</p>
                            <p class="text-sm text-purple-600">${med.frequency} ‚Ä¢ Times: ${med.times.join(', ')}</p>
                            ${med.notes ? `<p class="text-sm text-purple-500 mt-1">${med.notes}</p>` : ''}
                        </div>
                        <span class="text-purple-600 font-bold">üíä</span>
                    </div>
                `;
                
                list.appendChild(div);
            });
        }

        function markMedicationTaken(entryId) {
            const entry = medicationSchedule.find(e => e.id === entryId);
            if (entry) {
                entry.taken = !entry.taken;
                localStorage.setItem('medicationSchedule', JSON.stringify(medicationSchedule));
                updateMedicationSchedule();
                
                if (entry.taken) {
                    showSuccessMessage(`${entry.name} marked as taken!`);
                }
            }
        }

        function deleteMedicationFromSchedule(entryId) {
            const entry = medicationSchedule.find(e => e.id === entryId);
            if (entry && confirm(`Are you sure you want to delete this ${entry.name} reminder?`)) {
                medicationSchedule = medicationSchedule.filter(e => e.id !== entryId);
                localStorage.setItem('medicationSchedule', JSON.stringify(medicationSchedule));
                updateMedicationSchedule();
                showSuccessMessage(`${entry.name} reminder deleted!`);
            }
        }

        // Food functions
        function addFoodItem() {
            const name = document.getElementById('food-name').value;
            const quantity = parseFloat(document.getElementById('food-quantity').value);
            const unit = document.getElementById('food-unit').value;
            const calories = parseInt(document.getElementById('food-calories').value);
            const carbs = parseFloat(document.getElementById('food-carbs').value);
            const fiber = parseFloat(document.getElementById('food-fiber').value) || 0;
            const meal = document.getElementById('meal-type').value;
            
            if (!name || !quantity || !calories) {
                alert('Please fill in all required fields');
                return;
            }
            
            const foodItem = {
                id: Date.now(),
                name: name,
                quantity: quantity,
                unit: unit,
                calories: calories,
                carbs: carbs || 0,
                fiber: fiber,
                meal: meal,
                date: new Date()
            };
            
            foodItems.unshift(foodItem);
            localStorage.setItem('foodItems', JSON.stringify(foodItems));
            updateFoodSummary();
            
            // Clear form
            document.getElementById('food-name').value = '';
            document.getElementById('food-quantity').value = '';
            document.getElementById('food-calories').value = '';
            document.getElementById('food-carbs').value = '';
            document.getElementById('food-fiber').value = '';
            
            showSuccessMessage('Food item added successfully!');
            awardPoints(5, 'logging food');
        }

        function updateFoodSummary() {
            const today = new Date().toDateString();
            const todayItems = foodItems.filter(item => new Date(item.date).toDateString() === today);
            
            const totalCalories = todayItems.reduce((sum, item) => sum + (item.calories * item.quantity), 0);
            const totalCarbs = todayItems.reduce((sum, item) => sum + (item.carbs * item.quantity), 0);
            const totalFiber = todayItems.reduce((sum, item) => sum + (item.fiber * item.quantity), 0);
            const netCarbs = totalCarbs - totalFiber;
            
            document.getElementById('total-calories').textContent = totalCalories;
            document.getElementById('total-carbs').textContent = totalCarbs.toFixed(1) + 'g';
            document.getElementById('net-carbs').textContent = Math.max(0, netCarbs).toFixed(1) + 'g';
            
            // Update progress bars
            const caloriesPercent = Math.min((totalCalories / 2000) * 100, 100);
            const carbsPercent = Math.min((totalCarbs / 150) * 100, 100);
            
            document.getElementById('calories-bar').style.width = caloriesPercent + '%';
            document.getElementById('carbs-bar').style.width = carbsPercent + '%';
            
            // Update meals list
            const mealsList = document.getElementById('meals-list');
            mealsList.innerHTML = '';
            
            if (todayItems.length === 0) {
                mealsList.innerHTML = '<p class="text-gray-500 text-center py-4">No meals logged today.</p>';
                return;
            }
            
            todayItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-3 rounded-lg';
                div.innerHTML = `
                    <div class="flex justify-between">
                        <span class="font-medium">${item.name} (${item.quantity} ${item.unit})</span>
                        <span class="text-sm text-gray-600">${Math.round(item.calories * item.quantity)} cal</span>
                    </div>
                    <p class="text-sm text-gray-500">${item.meal.charAt(0).toUpperCase() + item.meal.slice(1)} ‚Ä¢ ${(item.carbs * item.quantity).toFixed(1)}g carbs</p>
                `;
                mealsList.appendChild(div);
            });
        }

        // Exercise functions
        function addExercise() {
            const type = document.getElementById('exercise-type').value;
            const duration = parseInt(document.getElementById('exercise-duration').value);
            const intensity = document.getElementById('exercise-intensity').value;
            const bgBefore = document.getElementById('exercise-bg-before').value;
            const bgAfter = document.getElementById('exercise-bg-after').value;
            const notes = document.getElementById('exercise-notes').value;
            
            if (!duration) {
                alert('Please enter exercise duration');
                return;
            }
            
            const exercise = {
                id: Date.now(),
                type: type,
                duration: duration,
                intensity: intensity,
                bgBefore: bgBefore ? parseInt(bgBefore) : null,
                bgAfter: bgAfter ? parseInt(bgAfter) : null,
                notes: notes,
                date: new Date()
            };
            
            exercises.unshift(exercise);
            localStorage.setItem('exercises', JSON.stringify(exercises));
            updateExerciseSummary();
            
            // Clear form
            document.getElementById('exercise-duration').value = '';
            document.getElementById('exercise-bg-before').value = '';
            document.getElementById('exercise-bg-after').value = '';
            document.getElementById('exercise-notes').value = '';
            
            showSuccessMessage('Exercise logged successfully!');
            awardPoints(12, 'logging exercise');
        }

        function updateExerciseSummary() {
            const today = new Date().toDateString();
            const todayExercises = exercises.filter(ex => new Date(ex.date).toDateString() === today);
            
            const totalTime = todayExercises.reduce((sum, ex) => sum + ex.duration, 0);
            
            document.getElementById('total-exercise-time').textContent = totalTime + ' min';
            
            // Update progress bar (goal: 150 minutes per week, so ~21 minutes per day)
            const timePercent = Math.min((totalTime / 21) * 100, 100);
            document.getElementById('exercise-time-bar').style.width = timePercent + '%';
            
            // Update exercise list
            const exerciseList = document.getElementById('exercise-list');
            exerciseList.innerHTML = '';
            
            if (todayExercises.length === 0) {
                exerciseList.innerHTML = '<p class="text-gray-500 text-center py-4">No exercises logged today.</p>';
                return;
            }
            
            todayExercises.forEach(ex => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-3 rounded-lg';
                div.innerHTML = `
                    <div class="flex justify-between">
                        <span class="font-medium">${ex.type.charAt(0).toUpperCase() + ex.type.slice(1)}</span>
                        <span class="text-sm text-gray-600">${ex.duration} min</span>
                    </div>
                    <p class="text-sm text-gray-500">${ex.intensity} intensity${ex.bgBefore ? ` ‚Ä¢ BG: ${ex.bgBefore}‚Üí${ex.bgAfter || '?'}` : ''}</p>
                `;
                exerciseList.appendChild(div);
            });
        }

        // Vitals functions
        function addWeight() {
            const weight = parseFloat(document.getElementById('weight-value').value);
            const weightUnit = document.getElementById('weight-unit').value;
            const date = document.getElementById('weight-date').value;
            
            if (!weight || weight <= 0) {
                alert('Please enter a valid weight (greater than 0)');
                return;
            }
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            // Convert to lbs for internal storage if needed
            let weightInLbs = weight;
            if (weightUnit === 'kg') {
                weightInLbs = weight * 2.20462;
            }
            
            const entry = {
                id: Date.now(),
                weight: weightInLbs,
                originalWeight: weight,
                unit: weightUnit,
                date: new Date(date)
            };
            
            weightEntries.unshift(entry);
            localStorage.setItem('weightEntries', JSON.stringify(weightEntries));
            updateVitalsDisplays();
            updateQuickStats();
            
            // Clear form
            document.getElementById('weight-value').value = '';
            
            showSuccessMessage('Weight entry added successfully!');
        }

        function addBloodPressure() {
            const systolic = parseInt(document.getElementById('bp-systolic').value);
            const diastolic = parseInt(document.getElementById('bp-diastolic').value);
            const pulse = parseInt(document.getElementById('bp-pulse').value) || null;
            const notes = document.getElementById('bp-notes').value || '';
            
            if (!systolic || systolic <= 0 || systolic > 300) {
                alert('Please enter a valid systolic pressure (1-300)');
                return;
            }
            
            if (!diastolic || diastolic <= 0 || diastolic > 200) {
                alert('Please enter a valid diastolic pressure (1-200)');
                return;
            }
            
            const reading = {
                id: Date.now(),
                systolic: systolic,
                diastolic: diastolic,
                pulse: pulse,
                notes: notes,
                date: new Date()
            };
            
            bloodPressureReadings.unshift(reading);
            localStorage.setItem('bloodPressureReadings', JSON.stringify(bloodPressureReadings));
            updateVitalsDisplays();
            updateQuickStats();
            
            // Clear form
            document.getElementById('bp-systolic').value = '';
            document.getElementById('bp-diastolic').value = '';
            document.getElementById('bp-pulse').value = '';
            document.getElementById('bp-notes').value = '';
            
            showSuccessMessage('Blood pressure reading added successfully!');
        }

        function addHbA1C() {
            const value = parseFloat(document.getElementById('hba1c-value').value);
            const date = document.getElementById('hba1c-date').value;
            const lab = document.getElementById('hba1c-lab').value || '';
            const notes = document.getElementById('hba1c-notes').value || '';
            
            if (!value || value <= 0 || value > 20) {
                alert('Please enter a valid HbA1C value (0.1-20.0%)');
                return;
            }
            
            if (!date) {
                alert('Please select a test date');
                return;
            }
            
            const reading = {
                id: Date.now(),
                value: value,
                date: new Date(date),
                lab: lab,
                notes: notes
            };
            
            hba1cReadings.unshift(reading);
            localStorage.setItem('hba1cReadings', JSON.stringify(hba1cReadings));
            updateHbA1CDisplay();
            updateQuickStats();
            
            // Clear form
            document.getElementById('hba1c-value').value = '';
            document.getElementById('hba1c-date').value = '';
            document.getElementById('hba1c-lab').value = '';
            document.getElementById('hba1c-notes').value = '';
            
            showSuccessMessage('HbA1C result added successfully!');
        }

        function updateVitalsDisplays() {
            updateBMI();
            updateWeightList();
            updateBPList();
            updateHbA1CDisplay();
        }

        function updateHbA1CDisplay() {
            if (hba1cReadings.length > 0) {
                const latest = hba1cReadings[0];
                document.getElementById('current-hba1c').textContent = latest.value.toFixed(1) + '%';
                document.getElementById('hba1c-date-display').textContent = new Date(latest.date).toLocaleDateString();
                
                const status = getHbA1CStatus(latest.value);
                const currentDisplay = document.getElementById('hba1c-current');
                currentDisplay.className = `mb-4 p-4 rounded-lg ${status.bgColor} border-l-4 ${status.borderColor}`;
                document.getElementById('hba1c-status').textContent = status.category;
                document.getElementById('hba1c-status').className = `${status.textColor} font-bold`;
            }
            
            // Update HbA1C list
            const list = document.getElementById('hba1c-list');
            list.innerHTML = '';
            
            if (hba1cReadings.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-2">No HbA1C results yet.</p>';
                return;
            }
            
            hba1cReadings.slice(0, 5).forEach(reading => {
                const status = getHbA1CStatus(reading.value);
                const div = document.createElement('div');
                div.className = `text-sm p-2 rounded ${status.bgColor}`;
                div.innerHTML = `
                    <div class="flex justify-between">
                        <span class="font-medium">${reading.value.toFixed(1)}%</span>
                        <span class="${status.textColor}">${status.category}</span>
                    </div>
                    <p class="text-gray-500">${new Date(reading.date).toLocaleDateString()}${reading.lab ? ` ‚Ä¢ ${reading.lab}` : ''}</p>
                    ${reading.notes ? `<p class="text-gray-500 text-xs mt-1">${reading.notes}</p>` : ''}
                `;
                list.appendChild(div);
            });
        }

        function getHbA1CStatus(value) {
            if (value < 5.7) {
                return { category: 'Normal', bgColor: 'bg-green-50', borderColor: 'border-green-400', textColor: 'text-green-600' };
            } else if (value < 6.5) {
                return { category: 'Pre-diabetes', bgColor: 'bg-yellow-50', borderColor: 'border-yellow-400', textColor: 'text-yellow-600' };
            } else if (value < 7.0) {
                return { category: 'Good Control', bgColor: 'bg-blue-50', borderColor: 'border-blue-400', textColor: 'text-blue-600' };
            } else if (value < 8.0) {
                return { category: 'Fair Control', bgColor: 'bg-orange-50', borderColor: 'border-orange-400', textColor: 'text-orange-600' };
            } else {
                return { category: 'Poor Control', bgColor: 'bg-red-50', borderColor: 'border-red-400', textColor: 'text-red-600' };
            }
        }

        function updateBMI() {
            if (weightEntries.length > 0) {
                const latestWeight = weightEntries[0].weight;
                
                // Use default height of 68 inches (5'8") if not set
                let heightInches = userProfile.height;
                if (!heightInches) {
                    heightInches = 68; // 5'8" default height
                    userProfile.height = heightInches;
                    localStorage.setItem('userProfile', JSON.stringify(userProfile));
                }
                
                const bmi = (latestWeight / (heightInches * heightInches)) * 703;
                
                document.getElementById('bmi-value').textContent = bmi.toFixed(1);
                document.getElementById('current-bmi').textContent = bmi.toFixed(1);
                
                const bmiStatus = getBMIStatus(bmi);
                const bmiDisplay = document.getElementById('bmi-display');
                bmiDisplay.className = `mb-6 p-4 rounded-lg ${bmiStatus.bgColor} border-l-4 ${bmiStatus.borderColor}`;
                document.getElementById('bmi-category').textContent = bmiStatus.category;
                document.getElementById('bmi-category').className = `${bmiStatus.textColor} font-bold`;
            } else {
                document.getElementById('bmi-value').textContent = '--';
                document.getElementById('bmi-category').textContent = 'Enter weight';
            }
        }

        function getBMIStatus(bmi) {
            if (bmi < 18.5) {
                return { category: 'Underweight', bgColor: 'bg-blue-50', borderColor: 'border-blue-400', textColor: 'text-blue-600' };
            } else if (bmi < 25) {
                return { category: 'Normal', bgColor: 'bg-green-50', borderColor: 'border-green-400', textColor: 'text-green-600' };
            } else if (bmi < 30) {
                return { category: 'Overweight', bgColor: 'bg-yellow-50', borderColor: 'border-yellow-400', textColor: 'text-yellow-600' };
            } else {
                return { category: 'Obese', bgColor: 'bg-red-50', borderColor: 'border-red-400', textColor: 'text-red-600' };
            }
        }

        function updateWeightList() {
            const list = document.getElementById('weight-list');
            list.innerHTML = '';
            
            if (weightEntries.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-2">No weight entries yet.</p>';
                return;
            }
            
            weightEntries.slice(0, 5).forEach(entry => {
                const div = document.createElement('div');
                div.className = 'flex justify-between text-sm bg-gray-50 p-2 rounded';
                
                // Display weight in original unit if available, otherwise convert from lbs
                let displayWeight;
                if (entry.originalWeight && entry.unit) {
                    displayWeight = `${entry.originalWeight} ${entry.unit}`;
                } else {
                    // Legacy entries - display in lbs
                    displayWeight = `${entry.weight.toFixed(1)} lbs`;
                }
                
                div.innerHTML = `
                    <span>${displayWeight}</span>
                    <span class="text-gray-500">${new Date(entry.date).toLocaleDateString()}</span>
                `;
                list.appendChild(div);
            });
        }

        function updateBPList() {
            const list = document.getElementById('bp-list');
            list.innerHTML = '';
            
            if (bloodPressureReadings.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-2">No BP readings yet.</p>';
                return;
            }
            
            bloodPressureReadings.slice(0, 5).forEach(reading => {
                const status = getBPStatus(reading.systolic, reading.diastolic);
                const div = document.createElement('div');
                div.className = `text-sm p-2 rounded ${status.bgColor}`;
                div.innerHTML = `
                    <div class="flex justify-between">
                        <span class="font-medium">${reading.systolic}/${reading.diastolic}</span>
                        <span class="${status.textColor}">${status.category}</span>
                    </div>
                    <p class="text-gray-500">${formatDate(reading.date)}${reading.pulse ? ` ‚Ä¢ ${reading.pulse} bpm` : ''}</p>
                `;
                list.appendChild(div);
            });
        }

        function getBPStatus(systolic, diastolic) {
            if (systolic < 120 && diastolic < 80) {
                return { category: 'Normal', bgColor: 'bg-green-50', textColor: 'text-green-600' };
            } else if (systolic < 130 && diastolic < 80) {
                return { category: 'Elevated', bgColor: 'bg-yellow-50', textColor: 'text-yellow-600' };
            } else if (systolic < 140 || diastolic < 90) {
                return { category: 'Stage 1', bgColor: 'bg-orange-50', textColor: 'text-orange-600' };
            } else {
                return { category: 'Stage 2', bgColor: 'bg-red-50', textColor: 'text-red-600' };
            }
        }

        // Appointments functions
        function addAppointment() {
            const type = document.getElementById('appointment-type').value;
            const date = document.getElementById('appointment-date').value;
            const time = document.getElementById('appointment-time').value;
            const doctor = document.getElementById('appointment-doctor').value;
            const location = document.getElementById('appointment-location').value;
            const notes = document.getElementById('appointment-notes').value;
            const reminder = document.getElementById('appointment-reminder').value;
            
            if (!date || !time) {
                alert('Please enter appointment date and time');
                return;
            }
            
            const appointment = {
                id: Date.now(),
                type: type,
                date: new Date(date + 'T' + time),
                doctor: doctor,
                location: location,
                notes: notes,
                reminder: reminder,
                completed: false
            };
            
            appointments.push(appointment);
            appointments.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('appointments', JSON.stringify(appointments));
            updateAppointmentsList();
            
            // Clear form
            document.getElementById('appointment-date').value = '';
            document.getElementById('appointment-time').value = '';
            document.getElementById('appointment-doctor').value = '';
            document.getElementById('appointment-location').value = '';
            document.getElementById('appointment-notes').value = '';
            
            showSuccessMessage('Appointment scheduled successfully!');
        }

        function updateAppointmentsList() {
            const list = document.getElementById('appointments-list');
            list.innerHTML = '';
            
            const upcomingAppointments = appointments.filter(apt => new Date(apt.date) > new Date() && !apt.completed);
            
            if (upcomingAppointments.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">No upcoming appointments scheduled.</p>';
                return;
            }
            
            upcomingAppointments.forEach(apt => {
                const div = document.createElement('div');
                div.className = 'bg-blue-50 border-l-4 border-blue-400 p-4 rounded';
                
                const appointmentDate = new Date(apt.date);
                const dateStr = appointmentDate.toLocaleDateString();
                const timeStr = appointmentDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-blue-800">${apt.type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                            <p class="text-sm text-blue-600">${dateStr} at ${timeStr}</p>
                            ${apt.doctor ? `<p class="text-sm text-blue-500">Dr: ${apt.doctor}</p>` : ''}
                            ${apt.location ? `<p class="text-sm text-blue-500">üìç ${apt.location}</p>` : ''}
                            ${apt.notes ? `<p class="text-sm text-blue-500 mt-1">${apt.notes}</p>` : ''}
                        </div>
                        <button onclick="markAppointmentCompleted(${apt.id})" class="text-blue-600 hover:text-blue-800 text-sm underline">
                            Mark Complete
                        </button>
                    </div>
                `;
                
                list.appendChild(div);
            });
        }

        function markAppointmentCompleted(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (appointment) {
                appointment.completed = true;
                localStorage.setItem('appointments', JSON.stringify(appointments));
                updateAppointmentsList();
                showSuccessMessage('Appointment marked as completed!');
            }
        }

        // Quick stats update
        function updateQuickStats() {
            // Average glucose (last 7 days)
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const recentReadings = glucoseReadings.filter(reading => new Date(reading.date) > weekAgo);
            
            if (recentReadings.length > 0) {
                const avgGlucose = recentReadings.reduce((sum, reading) => sum + reading.level, 0) / recentReadings.length;
                document.getElementById('avg-glucose').textContent = Math.round(avgGlucose) + ' mg/dL';
            }
            
            // Current weight
            if (weightEntries.length > 0) {
                const latestEntry = weightEntries[0];
                let displayWeight;
                if (latestEntry.originalWeight && latestEntry.unit) {
                    displayWeight = `${latestEntry.originalWeight} ${latestEntry.unit}`;
                } else {
                    displayWeight = `${latestEntry.weight.toFixed(1)} lbs`;
                }
                document.getElementById('current-weight').textContent = displayWeight;
            }
            
            // Current BMI
            if (weightEntries.length > 0 && userProfile.height) {
                const bmi = (weightEntries[0].weight / (userProfile.height * userProfile.height)) * 703;
                document.getElementById('current-bmi').textContent = bmi.toFixed(1);
            }
            
            // Last BP
            if (bloodPressureReadings.length > 0) {
                const lastBP = bloodPressureReadings[0];
                document.getElementById('last-bp').textContent = `${lastBP.systolic}/${lastBP.diastolic}`;
            }
        }

        // Enhanced reminder and alarm system
        function scheduleAllReminders() {
            // Clear existing timeouts
            reminderTimeouts.forEach(timeout => clearTimeout(timeout));
            appointmentTimeouts.forEach(timeout => clearTimeout(timeout));
            reminderTimeouts = [];
            appointmentTimeouts = [];
            
            // Schedule medication reminders
            medications.forEach(med => {
                if (med.active && med.times) {
                    med.times.forEach(time => {
                        scheduleReminder(med.name, med.dosage, time);
                    });
                }
            });

            // Schedule appointment reminders
            appointments.forEach(apt => {
                if (!apt.completed && new Date(apt.date) > new Date()) {
                    scheduleAppointmentReminder(apt);
                }
            });
        }

        function scheduleReminder(medName, dosage, time) {
            const now = new Date();
            const [hours, minutes] = time.split(':');
            const reminderTime = new Date();
            reminderTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            // If time has passed today, schedule for tomorrow
            if (reminderTime <= now) {
                reminderTime.setDate(reminderTime.getDate() + 1);
            }
            
            const timeUntilReminder = reminderTime.getTime() - now.getTime();
            
            const timeoutId = setTimeout(() => {
                showMedicationReminder(medName, dosage);
                // Reschedule for next day
                scheduleReminder(medName, dosage, time);
            }, timeUntilReminder);
            
            reminderTimeouts.push(timeoutId);
        }

        function scheduleAppointmentReminder(appointment) {
            const appointmentDate = new Date(appointment.date);
            const now = new Date();
            
            // Calculate reminder time based on reminder setting
            let reminderTime = new Date(appointmentDate);
            
            switch(appointment.reminder) {
                case '1-day':
                    reminderTime.setDate(reminderTime.getDate() - 1);
                    break;
                case '2-days':
                    reminderTime.setDate(reminderTime.getDate() - 2);
                    break;
                case '1-week':
                    reminderTime.setDate(reminderTime.getDate() - 7);
                    break;
                default:
                    return; // No reminder
            }
            
            // Set reminder time to 9 AM
            reminderTime.setHours(9, 0, 0, 0);
            
            if (reminderTime > now) {
                const timeUntilReminder = reminderTime.getTime() - now.getTime();
                
                const timeoutId = setTimeout(() => {
                    showAppointmentReminder(appointment);
                }, timeUntilReminder);
                
                appointmentTimeouts.push(timeoutId);
            }
        }

        function showMedicationReminder(medName, dosage) {
            currentReminderType = 'medication';
            document.getElementById('reminder-message').textContent = `Time to take ${medName} ${dosage}`;
            document.getElementById('reminder-modal').classList.remove('hidden');
            startAlarm();
        }

        function showAppointmentReminder(appointment) {
            currentReminderType = 'appointment';
            const appointmentDate = new Date(appointment.date);
            const dateStr = appointmentDate.toLocaleDateString();
            const timeStr = appointmentDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            
            document.getElementById('appointment-reminder-message').innerHTML = `
                <strong>${appointment.type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong><br>
                ${dateStr} at ${timeStr}<br>
                ${appointment.doctor ? `Dr: ${appointment.doctor}` : ''}
            `;
            document.getElementById('appointment-reminder-modal').classList.remove('hidden');
            startAlarm();
        }

        function startAlarm() {
            // Create audio context for real alarm sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Visual alarm with flashing and REAL sound
            let flashCount = 0;
            alarmInterval = setInterval(() => {
                // Flash the browser tab title
                document.title = flashCount % 2 === 0 ? 'üîî REMINDER ACTIVE - DiabetesTracker' : 'DiabetesTracker Pro';
                
                // Generate real beeping sound
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // 800Hz beep
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
                
                // Try to get user attention with notification if supported
                if (flashCount === 0 && 'Notification' in window) {
                    if (Notification.permission === 'granted') {
                        const notification = new Notification('DiabetesTracker Reminder', {
                            body: currentReminderType === 'medication' ? 'Time for your medication!' : 'Upcoming appointment reminder!',
                            icon: 'ü©∫',
                            requireInteraction: true
                        });
                        
                        setTimeout(() => notification.close(), 10000);
                    } else if (Notification.permission !== 'denied') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                new Notification('DiabetesTracker Reminder', {
                                    body: currentReminderType === 'medication' ? 'Time for your medication!' : 'Upcoming appointment reminder!',
                                    icon: 'ü©∫'
                                });
                            }
                        });
                    }
                }
                
                flashCount++;
                if (flashCount > 60) { // Stop after 30 seconds
                    stopAlarm();
                }
            }, 1000);
        }

        function stopAlarm() {
            if (alarmInterval) {
                clearInterval(alarmInterval);
                alarmInterval = null;
            }
            document.title = 'DiabetesTracker Pro';
            currentReminderType = null;
        }

        function snoozeReminder() {
            stopAlarm();
            document.getElementById('reminder-modal').classList.add('hidden');
            
            // Snooze for 15 minutes
            setTimeout(() => {
                const medName = document.getElementById('reminder-message').textContent.split('Time to take ')[1];
                if (medName) {
                    showMedicationReminder(medName.split(' ')[0], medName.split(' ').slice(1).join(' '));
                }
            }, 15 * 60 * 1000);
        }

        function dismissReminder() {
            stopAlarm();
            document.getElementById('reminder-modal').classList.add('hidden');
            
            // Mark medication as taken in today's schedule
            const today = new Date().toDateString();
            const medName = document.getElementById('reminder-message').textContent.split('Time to take ')[1];
            if (medName) {
                const scheduleEntry = medicationSchedule.find(entry => 
                    entry.date === today && 
                    entry.name === medName.split(' ')[0] && 
                    !entry.taken
                );
                if (scheduleEntry) {
                    scheduleEntry.taken = true;
                    localStorage.setItem('medicationSchedule', JSON.stringify(medicationSchedule));
                    updateMedicationSchedule();
                }
            }
        }

        function snoozeAppointmentReminder() {
            stopAlarm();
            document.getElementById('appointment-reminder-modal').classList.add('hidden');
            
            // Snooze for 4 hours
            setTimeout(() => {
                document.getElementById('appointment-reminder-modal').classList.remove('hidden');
                startAlarm();
            }, 4 * 60 * 60 * 1000);
        }

        function dismissAppointmentReminder() {
            stopAlarm();
            document.getElementById('appointment-reminder-modal').classList.add('hidden');
        }

        // Utility functions
        function formatDate(date) {
            const dateObj = new Date(date);
            const now = new Date();
            const diffTime = Math.abs(now - dateObj);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                return 'Today ' + dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else if (diffDays === 2) {
                return 'Yesterday ' + dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else {
                return dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }

        function showSuccessMessage(message) {
            document.getElementById('success-text').textContent = message;
            document.getElementById('success-message').classList.remove('hidden');
            
            setTimeout(() => {
                document.getElementById('success-message').classList.add('hidden');
            }, 3000);
        }

        function updateAllDisplays() {
            updateGlucoseList();
            updateInsulinList();
            updateMedicationDisplays();
            updateFoodSummary();
            updateExerciseSummary();
            updateVitalsDisplays();
            updateAppointmentsList();
            updateQuickStats();
            updateGamificationDisplay();
            updateAchievementsList();
            updateDailyChallenges();
            updateMessagesList();
            updateExportCounts();
            updateLabResultsDisplay();
            updateCurrentMedicationsList();
            updateHealthSummary();
            document.getElementById('current-hba1c-goal').textContent = hba1cGoal.toFixed(1) + '%';
        }

        // Health Summary Functions
        function updateHealthSummary() {
            // Update report date
            document.getElementById('report-date').textContent = new Date().toLocaleDateString();
            
            // Update patient information
            document.getElementById('summary-age').textContent = userProfile.age || '--';
            document.getElementById('summary-sex').textContent = userProfile.sex || '--';
            if (userProfile.height) {
                if (userProfile.heightUnit === 'metric') {
                    const heightCm = Math.round(userProfile.height * 2.54);
                    document.getElementById('summary-height').textContent = `${heightCm} cm`;
                } else {
                    const feet = Math.floor(userProfile.height / 12);
                    const inches = userProfile.height % 12;
                    document.getElementById('summary-height').textContent = `${feet}'${inches}"`;
                }
            }
            document.getElementById('summary-diabetes-type').textContent = diabetesType || '--';
            
            // Update key metrics
            updateSummaryKeyMetrics();
            updateSummaryLabResults();
            updateSummaryGlucoseTrends();
            updateSummaryMedications();
            updateSummaryLifestyle();
            updateSummaryAppointments();
        }

        function updateSummaryKeyMetrics() {
            // Latest HbA1c
            if (hba1cReadings.length > 0) {
                const latest = hba1cReadings[0];
                document.getElementById('summary-hba1c').textContent = latest.value.toFixed(1) + '%';
                document.getElementById('summary-hba1c-date').textContent = new Date(latest.date).toLocaleDateString();
            }
            
            // Average glucose (last 7 days)
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const recentReadings = glucoseReadings.filter(reading => new Date(reading.date) > weekAgo);
            
            if (recentReadings.length > 0) {
                const avgGlucose = recentReadings.reduce((sum, reading) => sum + reading.level, 0) / recentReadings.length;
                document.getElementById('summary-avg-glucose').textContent = Math.round(avgGlucose) + ' mg/dL';
                document.getElementById('summary-glucose-readings').textContent = recentReadings.length + ' readings';
            }
            
            // Current weight and BMI
            if (weightEntries.length > 0) {
                const latestEntry = weightEntries[0];
                let displayWeight;
                if (latestEntry.originalWeight && latestEntry.unit) {
                    displayWeight = `${latestEntry.originalWeight} ${latestEntry.unit}`;
                } else {
                    displayWeight = `${latestEntry.weight.toFixed(1)} lbs`;
                }
                document.getElementById('summary-weight').textContent = displayWeight;
                
                if (userProfile.height) {
                    // Use weight in lbs for BMI calculation
                    const weightInLbs = latestEntry.weight;
                    const bmi = (weightInLbs / (userProfile.height * userProfile.height)) * 703;
                    document.getElementById('summary-bmi').textContent = bmi.toFixed(1);
                }
            }
            
            // Latest blood pressure
            if (bloodPressureReadings.length > 0) {
                const latest = bloodPressureReadings[0];
                document.getElementById('summary-bp').textContent = `${latest.systolic}/${latest.diastolic}`;
                document.getElementById('summary-bp-date').textContent = new Date(latest.date).toLocaleDateString();
            }
        }

        function updateSummaryLabResults() {
            const container = document.getElementById('summary-lab-results');
            container.innerHTML = '';
            
            if (labResults.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No lab results available.</p>';
                return;
            }
            
            // Show latest 3 lab results
            labResults.slice(0, 3).forEach(result => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4';
                
                let labValues = [];
                if (result.hba1c !== null) labValues.push(`HbA1c: ${result.hba1c.toFixed(1)}%`);
                if (result.totalCholesterol !== null) labValues.push(`Total Chol: ${result.totalCholesterol} mg/dL`);
                if (result.ldl !== null) labValues.push(`LDL: ${result.ldl} mg/dL`);
                if (result.hdl !== null) labValues.push(`HDL: ${result.hdl} mg/dL`);
                if (result.triglycerides !== null) labValues.push(`Triglycerides: ${result.triglycerides} mg/dL`);
                if (result.creatinine !== null) labValues.push(`Creatinine: ${result.creatinine} mg/dL`);
                if (result.egfr !== null) labValues.push(`eGFR: ${result.egfr} mL/min/1.73m¬≤`);
                if (result.acr !== null) labValues.push(`ACR: ${result.acr} mg/g`);
                if (result.alt !== null) labValues.push(`ALT: ${result.alt} U/L`);
                if (result.ast !== null) labValues.push(`AST: ${result.ast} U/L`);
                
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800">${new Date(result.date).toLocaleDateString()}</h3>
                        <span class="text-sm text-gray-500">${result.facility || 'Lab'}</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
                        ${labValues.map(value => `<span class="bg-white px-2 py-1 rounded text-gray-700">${value}</span>`).join('')}
                    </div>
                    ${result.notes ? `<p class="text-sm text-gray-600 mt-2 italic">${result.notes}</p>` : ''}
                `;
                
                container.appendChild(div);
            });
        }

        function updateSummaryGlucoseTrends() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const recentReadings = glucoseReadings.filter(reading => new Date(reading.date) > thirtyDaysAgo);
            
            if (recentReadings.length === 0) {
                document.getElementById('glucose-in-range').textContent = '--%';
                document.getElementById('glucose-low').textContent = '--%';
                document.getElementById('glucose-high').textContent = '--%';
                document.getElementById('summary-glucose-list').innerHTML = '<p class="text-gray-500 text-center py-4">No glucose readings in the last 30 days.</p>';
                return;
            }
            
            const inRange = recentReadings.filter(r => r.level >= 70 && r.level <= 180).length;
            const low = recentReadings.filter(r => r.level < 70).length;
            const high = recentReadings.filter(r => r.level > 180).length;
            const total = recentReadings.length;
            
            document.getElementById('glucose-in-range').textContent = Math.round((inRange / total) * 100) + '%';
            document.getElementById('glucose-low').textContent = Math.round((low / total) * 100) + '%';
            document.getElementById('glucose-high').textContent = Math.round((high / total) * 100) + '%';
            
            // Show recent readings
            const list = document.getElementById('summary-glucose-list');
            list.innerHTML = '';
            
            recentReadings.slice(0, 10).forEach(reading => {
                const status = getGlucoseStatus(reading.level, reading.time);
                const div = document.createElement('div');
                div.className = `${status.bgColor} border-l-4 ${status.borderColor} p-3 rounded text-sm`;
                
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-semibold ${status.textColor}">${reading.level} mg/dL</span>
                            <span class="text-gray-600 ml-2">${reading.time.replace('-', ' ')}</span>
                        </div>
                        <div class="text-right">
                            <span class="${status.textColor} font-medium">${status.label}</span>
                            <p class="text-xs text-gray-500">${new Date(reading.date).toLocaleDateString()}</p>
                        </div>
                    </div>
                `;
                
                list.appendChild(div);
            });
        }

        function updateSummaryMedications() {
            const container = document.getElementById('summary-medications');
            container.innerHTML = '';
            
            const activeMedications = medications.filter(med => med.active);
            
            if (activeMedications.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No active medications.</p>';
                return;
            }
            
            activeMedications.forEach(med => {
                const div = document.createElement('div');
                div.className = 'bg-blue-50 border-l-4 border-blue-400 p-3 rounded';
                
                const typeColors = {
                    'diabetes': 'bg-red-100 text-red-800',
                    'blood-pressure': 'bg-blue-100 text-blue-800',
                    'cholesterol': 'bg-yellow-100 text-yellow-800',
                    'heart': 'bg-pink-100 text-pink-800',
                    'vitamin': 'bg-green-100 text-green-800',
                    'other': 'bg-gray-100 text-gray-800'
                };
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-semibold text-blue-800">${med.name} ${med.dosage}</span>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${typeColors[med.type] || typeColors.other}">
                                    ${med.type ? med.type.replace('-', ' ') : 'medication'}
                                </span>
                            </div>
                            <p class="text-sm text-blue-600">${med.frequency.replace('-', ' ')} ‚Ä¢ Times: ${med.times.join(', ')}</p>
                            ${med.notes ? `<p class="text-sm text-blue-500 mt-1">${med.notes}</p>` : ''}
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function updateSummaryLifestyle() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            // Exercise summary
            const recentExercises = exercises.filter(ex => new Date(ex.date) > thirtyDaysAgo);
            const totalMinutes = recentExercises.reduce((sum, ex) => sum + ex.duration, 0);
            
            document.getElementById('summary-exercise-count').textContent = recentExercises.length;
            document.getElementById('summary-exercise-minutes').textContent = totalMinutes;
            
            // Food summary
            const recentFood = foodItems.filter(food => new Date(food.date) > thirtyDaysAgo);
            const totalCarbs = recentFood.reduce((sum, food) => sum + (food.carbs * food.quantity), 0);
            const avgDailyCarbs = recentFood.length > 0 ? totalCarbs / 30 : 0;
            
            document.getElementById('summary-food-count').textContent = recentFood.length;
            document.getElementById('summary-avg-carbs').textContent = avgDailyCarbs.toFixed(1);
        }

        function updateSummaryAppointments() {
            const container = document.getElementById('summary-appointments');
            container.innerHTML = '';
            
            const upcomingAppointments = appointments.filter(apt => new Date(apt.date) > new Date() && !apt.completed);
            
            if (upcomingAppointments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No upcoming appointments scheduled.</p>';
                return;
            }
            
            upcomingAppointments.slice(0, 5).forEach(apt => {
                const div = document.createElement('div');
                div.className = 'bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded';
                
                const appointmentDate = new Date(apt.date);
                const dateStr = appointmentDate.toLocaleDateString();
                const timeStr = appointmentDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-yellow-800">${apt.type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                            <p class="text-sm text-yellow-600">${dateStr} at ${timeStr}</p>
                            ${apt.doctor ? `<p class="text-sm text-yellow-500">Dr: ${apt.doctor}</p>` : ''}
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function printHealthSummary() {
            const printContent = document.getElementById('health-summary-content').innerHTML;
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Health Summary Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                        .bg-white { background: white; }
                        .rounded-xl, .rounded-lg, .rounded { border-radius: 8px; }
                        .shadow-lg { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                        .p-8, .p-6, .p-4, .p-3 { padding: 16px; }
                        .mb-8, .mb-6, .mb-4, .mb-2 { margin-bottom: 16px; }
                        .grid { display: grid; gap: 16px; }
                        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
                        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
                        .border-l-4 { border-left: 4px solid; }
                        .border-blue-500 { border-color: #3b82f6; }
                        .border-green-500 { border-color: #10b981; }
                        .border-red-500 { border-color: #ef4444; }
                        .border-purple-500 { border-color: #8b5cf6; }
                        .border-yellow-500 { border-color: #f59e0b; }
                        .text-xl { font-size: 1.25rem; }
                        .text-2xl { font-size: 1.5rem; }
                        .text-3xl { font-size: 1.875rem; }
                        .font-bold { font-weight: bold; }
                        .font-semibold { font-weight: 600; }
                        .text-gray-800 { color: #1f2937; }
                        .text-gray-600 { color: #4b5563; }
                        .text-gray-500 { color: #6b7280; }
                        .text-center { text-align: center; }
                        .border-b { border-bottom: 1px solid #e5e7eb; }
                        .pb-6 { padding-bottom: 24px; }
                        .pt-4 { padding-top: 16px; }
                        .bg-gray-50 { background-color: #f9fafb; }
                        .bg-red-50 { background-color: #fef2f2; }
                        .bg-blue-50 { background-color: #eff6ff; }
                        .bg-green-50 { background-color: #f0fdf4; }
                        .bg-yellow-50 { background-color: #fefce8; }
                        .bg-purple-50 { background-color: #faf5ff; }
                        .bg-orange-50 { background-color: #fff7ed; }
                        .border-red-400 { border-color: #f87171; }
                        .border-blue-400 { border-color: #60a5fa; }
                        .border-green-400 { border-color: #4ade80; }
                        .border-yellow-400 { border-color: #facc15; }
                        .border-purple-400 { border-color: #a78bfa; }
                        .border-orange-400 { border-color: #fb923c; }
                        .text-red-600, .text-red-800 { color: #dc2626; }
                        .text-blue-600, .text-blue-800 { color: #2563eb; }
                        .text-green-600, .text-green-800 { color: #16a34a; }
                        .text-yellow-600, .text-yellow-800 { color: #ca8a04; }
                        .text-purple-600, .text-purple-800 { color: #9333ea; }
                        .text-orange-600, .text-orange-800 { color: #ea580c; }
                        .text-red-500 { color: #ef4444; }
                        .text-blue-500 { color: #3b82f6; }
                        .text-green-500 { color: #10b981; }
                        .text-yellow-500 { color: #f59e0b; }
                        .text-purple-500 { color: #8b5cf6; }
                        .text-orange-500 { color: #f97316; }
                        .text-sm { font-size: 0.875rem; }
                        .text-xs { font-size: 0.75rem; }
                        .space-y-2 > * + * { margin-top: 8px; }
                        .space-y-4 > * + * { margin-top: 16px; }
                        .max-h-64 { max-height: 256px; }
                        .overflow-y-auto { overflow-y: auto; }
                        .hidden { display: none; }
                        .flex { display: flex; }
                        .justify-between { justify-content: space-between; }
                        .justify-center { justify-content: center; }
                        .items-center { align-items: center; }
                        .items-start { align-items: flex-start; }
                        .gap-4 { gap: 16px; }
                        .gap-2 { gap: 8px; }
                        .gap-6 { gap: 24px; }
                        .mt-4 { margin-top: 16px; }
                        .mt-2 { margin-top: 8px; }
                        .mt-1 { margin-top: 4px; }
                        .ml-2 { margin-left: 8px; }
                        .border { border: 1px solid #e5e7eb; }
                        .border-gray-200 { border-color: #e5e7eb; }
                        .italic { font-style: italic; }
                        @media print {
                            button { display: none !important; }
                            .no-print { display: none !important; }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
            
            showSuccessMessage('Health summary prepared for printing!');
        }

        function exportHealthSummaryPDF() {
            // Create a comprehensive HTML document for PDF export
            const summaryContent = document.getElementById('health-summary-content').innerHTML;
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Diabetes Health Summary Report</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 0; 
                            padding: 20px; 
                            color: #333; 
                            line-height: 1.4;
                        }
                        .container { max-width: 800px; margin: 0 auto; }
                        h1 { color: #2563eb; border-bottom: 2px solid #2563eb; padding-bottom: 10px; }
                        h2 { color: #1f2937; margin-top: 30px; border-left: 4px solid #3b82f6; padding-left: 15px; }
                        h3 { color: #374151; margin-top: 20px; }
                        .grid { display: grid; gap: 15px; margin: 15px 0; }
                        .grid-2 { grid-template-columns: repeat(2, 1fr); }
                        .grid-3 { grid-template-columns: repeat(3, 1fr); }
                        .grid-4 { grid-template-columns: repeat(4, 1fr); }
                        .card { 
                            background: #f9fafb; 
                            padding: 15px; 
                            border-radius: 8px; 
                            border-left: 4px solid #6b7280;
                        }
                        .card-red { border-left-color: #ef4444; background: #fef2f2; }
                        .card-blue { border-left-color: #3b82f6; background: #eff6ff; }
                        .card-green { border-left-color: #10b981; background: #f0fdf4; }
                        .card-yellow { border-left-color: #f59e0b; background: #fefce8; }
                        .card-purple { border-left-color: #8b5cf6; background: #faf5ff; }
                        .card-orange { border-left-color: #f97316; background: #fff7ed; }
                        .metric-value { font-size: 24px; font-weight: bold; margin: 5px 0; }
                        .metric-label { font-size: 14px; color: #6b7280; }
                        .metric-date { font-size: 12px; color: #9ca3af; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
                        th { background-color: #f3f4f6; font-weight: bold; }
                        .summary-box { 
                            background: #f0f9ff; 
                            padding: 20px; 
                            border-radius: 8px; 
                            margin: 20px 0; 
                            border: 1px solid #bfdbfe;
                        }
                        .footer { 
                            text-align: center; 
                            font-size: 12px; 
                            color: #6b7280; 
                            border-top: 1px solid #e5e7eb; 
                            padding-top: 15px; 
                            margin-top: 30px;
                        }
                        .medication-list, .lab-list, .glucose-list { 
                            background: white; 
                            border: 1px solid #e5e7eb; 
                            border-radius: 6px; 
                            padding: 10px; 
                            margin: 10px 0;
                        }
                        .reading-item { 
                            padding: 8px; 
                            margin: 5px 0; 
                            border-left: 3px solid #e5e7eb; 
                            background: #f9fafb;
                        }
                        .reading-normal { border-left-color: #10b981; background: #f0fdf4; }
                        .reading-high { border-left-color: #ef4444; background: #fef2f2; }
                        .reading-low { border-left-color: #f59e0b; background: #fefce8; }
                        button { display: none; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        ${summaryContent.replace(/onclick="[^"]*"/g, '').replace(/class="[^"]*button[^"]*"/g, 'style="display:none"')}
                    </div>
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diabetes-health-summary-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccessMessage('Health summary exported! Open the file and use your browser\'s "Print to PDF" option to create a PDF.');
            awardPoints(20, 'exporting health summary');
        }

        // Test alarm function
        function testAlarm() {
            currentReminderType = 'medication';
            document.getElementById('reminder-message').textContent = 'Test alarm - This is how medication reminders work!';
            document.getElementById('reminder-modal').classList.remove('hidden');
            startAlarm();
        }

        // Gamification System
        function awardPoints(points, activity) {
            userPoints += points;
            localStorage.setItem('userPoints', userPoints);
            
            // Check for level up
            const newLevel = Math.floor(userPoints / 100) + 1;
            if (newLevel > userLevel) {
                userLevel = newLevel;
                localStorage.setItem('userLevel', userLevel);
                showLevelUpAnimation(newLevel);
            }
            
            // Update streak
            updateStreak();
            
            // Check for achievements
            checkAchievements(activity);
            
            // Update display
            updateGamificationDisplay();
            
            // Show points earned animation
            showPointsEarned(points, activity);
        }

        function updateStreak() {
            const today = new Date().toDateString();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toDateString();
            
            if (lastActivityDate === today) {
                // Already counted today
                return;
            } else if (lastActivityDate === yesterdayStr) {
                // Continuing streak
                streakDays++;
            } else if (lastActivityDate !== null) {
                // Streak broken
                streakDays = 1;
            } else {
                // First activity
                streakDays = 1;
            }
            
            lastActivityDate = today;
            localStorage.setItem('streakDays', streakDays);
            localStorage.setItem('lastActivityDate', lastActivityDate);
        }

        function updateGamificationDisplay() {
            document.getElementById('user-level').textContent = userLevel;
            document.getElementById('user-points').textContent = userPoints;
            document.getElementById('streak-days').textContent = streakDays;
            
            // Update level badge
            const badge = document.getElementById('user-level-badge');
            if (userLevel >= 10) badge.textContent = 'üèÜ';
            else if (userLevel >= 5) badge.textContent = 'ü•á';
            else if (userLevel >= 3) badge.textContent = 'ü•à';
            else badge.textContent = 'ü•â';
            
            // Update progress bar
            const pointsInCurrentLevel = userPoints % 100;
            const progressPercent = pointsInCurrentLevel;
            document.getElementById('level-progress').style.width = progressPercent + '%';
            document.getElementById('points-to-next').textContent = 100 - pointsInCurrentLevel;
        }

        function showPointsEarned(points, activity) {
            const pointsDiv = document.createElement('div');
            pointsDiv.className = 'fixed top-20 right-4 z-50 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg animate-bounce';
            pointsDiv.innerHTML = `+${points} points for ${activity}!`;
            document.body.appendChild(pointsDiv);
            
            setTimeout(() => {
                pointsDiv.remove();
            }, 3000);
        }

        function showLevelUpAnimation(level) {
            const levelUpDiv = document.createElement('div');
            levelUpDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            levelUpDiv.innerHTML = `
                <div class="bg-white rounded-xl p-8 text-center animate-pulse">
                    <div class="text-6xl mb-4">üéâ</div>
                    <h2 class="text-3xl font-bold text-yellow-600 mb-2">LEVEL UP!</h2>
                    <p class="text-xl text-gray-800">You reached Level ${level}!</p>
                    <button onclick="this.parentElement.parentElement.remove()" class="mt-4 bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg font-semibold">
                        Awesome! üöÄ
                    </button>
                </div>
            `;
            document.body.appendChild(levelUpDiv);
        }

        function checkAchievements(activity) {
            const achievementDefs = [
                { id: 'first_glucose', name: 'First Steps', description: 'Log your first glucose reading', icon: 'ü©∏', condition: () => glucoseReadings.length >= 1 },
                { id: 'glucose_week', name: 'Consistent Tracker', description: 'Log glucose for 7 days', icon: 'üìä', condition: () => glucoseReadings.length >= 7 },
                { id: 'exercise_start', name: 'Moving Forward', description: 'Log your first exercise', icon: 'üèÉ', condition: () => exercises.length >= 1 },
                { id: 'streak_3', name: 'Building Habits', description: '3-day activity streak', icon: 'üî•', condition: () => streakDays >= 3 },
                { id: 'streak_7', name: 'Week Warrior', description: '7-day activity streak', icon: '‚ö°', condition: () => streakDays >= 7 },
                { id: 'level_5', name: 'Diabetes Champion', description: 'Reach Level 5', icon: 'üèÜ', condition: () => userLevel >= 5 },
                { id: 'hba1c_goal', name: 'Goal Achiever', description: 'Meet your HbA1c goal', icon: 'üéØ', condition: () => hba1cReadings.length > 0 && hba1cReadings[0].value <= hba1cGoal }
            ];
            
            achievementDefs.forEach(def => {
                if (!achievements.find(a => a.id === def.id) && def.condition()) {
                    const achievement = {
                        id: def.id,
                        name: def.name,
                        description: def.description,
                        icon: def.icon,
                        dateEarned: new Date(),
                        points: 50
                    };
                    achievements.push(achievement);
                    localStorage.setItem('achievements', JSON.stringify(achievements));
                    showAchievementUnlocked(achievement);
                    awardPoints(50, 'achievement');
                }
            });
        }

        function showAchievementUnlocked(achievement) {
            const achievementDiv = document.createElement('div');
            achievementDiv.className = 'fixed top-4 left-4 z-50 bg-yellow-500 text-white p-4 rounded-lg shadow-lg max-w-sm animate-bounce';
            achievementDiv.innerHTML = `
                <div class="flex items-center">
                    <div class="text-3xl mr-3">${achievement.icon}</div>
                    <div>
                        <h3 class="font-bold">Achievement Unlocked!</h3>
                        <p class="text-sm">${achievement.name}</p>
                        <p class="text-xs opacity-90">${achievement.description}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(achievementDiv);
            
            setTimeout(() => {
                achievementDiv.remove();
            }, 5000);
        }

        function updateAchievementsList() {
            const list = document.getElementById('achievements-list');
            list.innerHTML = '';
            
            if (achievements.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">No achievements yet. Start tracking to unlock achievements!</p>';
                return;
            }
            
            achievements.forEach(achievement => {
                const div = document.createElement('div');
                div.className = 'bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg';
                div.innerHTML = `
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">${achievement.icon}</div>
                        <div>
                            <h3 class="font-bold text-yellow-800">${achievement.name}</h3>
                            <p class="text-sm text-yellow-700">${achievement.description}</p>
                            <p class="text-xs text-yellow-600">Earned: ${new Date(achievement.dateEarned).toLocaleDateString()}</p>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function updateDailyChallenges() {
            const challenges = [
                { id: 'glucose_today', name: 'Log Glucose Reading', icon: 'ü©∏', completed: glucoseReadings.some(r => new Date(r.date).toDateString() === new Date().toDateString()) },
                { id: 'exercise_today', name: 'Log Exercise Activity', icon: 'üèÉ', completed: exercises.some(e => new Date(e.date).toDateString() === new Date().toDateString()) },
                { id: 'medication_today', name: 'Take All Medications', icon: 'üíä', completed: medicationSchedule.filter(m => m.date === new Date().toDateString()).every(m => m.taken) },
                { id: 'food_today', name: 'Log Your Meals', icon: 'üçé', completed: foodItems.some(f => new Date(f.date).toDateString() === new Date().toDateString()) }
            ];
            
            const challengesList = document.getElementById('daily-challenges');
            challengesList.innerHTML = '';
            
            challenges.forEach(challenge => {
                const div = document.createElement('div');
                const statusClass = challenge.completed ? 'bg-green-50 border-green-400' : 'bg-gray-50 border-gray-300';
                const statusIcon = challenge.completed ? '‚úÖ' : '‚è≥';
                
                div.className = `${statusClass} border-l-4 p-3 rounded`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <span class="text-xl mr-3">${challenge.icon}</span>
                            <span class="font-medium">${challenge.name}</span>
                        </div>
                        <span class="text-xl">${statusIcon}</span>
                    </div>
                `;
                challengesList.appendChild(div);
            });
        }

        // HbA1c Goal Functions
        function setHbA1CGoal() {
            const goal = parseFloat(document.getElementById('hba1c-goal').value);
            if (!goal || goal < 4.0 || goal > 12.0) {
                alert('Please enter a valid HbA1c goal between 4.0% and 12.0%');
                return;
            }
            
            hba1cGoal = goal;
            localStorage.setItem('hba1cGoal', hba1cGoal);
            document.getElementById('current-hba1c-goal').textContent = hba1cGoal.toFixed(1) + '%';
            document.getElementById('hba1c-goal').value = '';
            
            showSuccessMessage(`HbA1c goal set to ${hba1cGoal.toFixed(1)}%!`);
            awardPoints(10, 'setting goal');
        }

        // Messaging Functions
        function sendMessage() {
            const recipient = document.getElementById('message-recipient').value;
            const subject = document.getElementById('message-subject').value;
            const priority = document.getElementById('message-priority').value;
            const content = document.getElementById('message-content').value;
            const attachData = document.getElementById('attach-data').checked;
            
            if (!subject || !content) {
                alert('Please fill in subject and message content');
                return;
            }
            
            const message = {
                id: Date.now(),
                recipient: recipient,
                subject: subject,
                priority: priority,
                content: content,
                attachData: attachData,
                dateSent: new Date(),
                status: 'sent',
                replies: []
            };
            
            messages.unshift(message);
            localStorage.setItem('messages', JSON.stringify(messages));
            
            // Simulate auto-reply for demo
            setTimeout(() => {
                const autoReply = {
                    id: Date.now(),
                    recipient: 'You',
                    subject: 'Re: ' + subject,
                    priority: 'normal',
                    content: 'Thank you for your message. We have received your inquiry and will respond within 24-48 hours. If this is urgent, please call our office directly.',
                    dateSent: new Date(),
                    status: 'received',
                    isReply: true
                };
                messages.unshift(autoReply);
                localStorage.setItem('messages', JSON.stringify(messages));
                updateMessagesList();
            }, 2000);
            
            updateMessagesList();
            
            // Clear form
            document.getElementById('message-subject').value = '';
            document.getElementById('message-content').value = '';
            document.getElementById('attach-data').checked = false;
            
            showSuccessMessage('Message sent to healthcare team!');
            awardPoints(5, 'messaging healthcare team');
        }

        function updateMessagesList() {
            const list = document.getElementById('messages-list');
            list.innerHTML = '';
            
            if (messages.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">No messages yet. Send a message to your healthcare team!</p>';
                return;
            }
            
            messages.slice(0, 10).forEach(message => {
                const div = document.createElement('div');
                const priorityColors = {
                    low: 'bg-gray-50 border-gray-300',
                    normal: 'bg-blue-50 border-blue-300',
                    high: 'bg-orange-50 border-orange-300',
                    emergency: 'bg-red-50 border-red-300'
                };
                
                const statusIcon = message.status === 'sent' ? 'üì§' : 'üì•';
                const isReply = message.isReply ? '‚Ü©Ô∏è ' : '';
                
                div.className = `${priorityColors[message.priority]} border-l-4 p-4 rounded`;
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800">${isReply}${message.subject}</h3>
                        <span class="text-xl">${statusIcon}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${message.content.substring(0, 100)}${message.content.length > 100 ? '...' : ''}</p>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>To: ${message.recipient}</span>
                        <span>${new Date(message.dateSent).toLocaleDateString()}</span>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // Lab Results Functions
        function addLabResults() {
            const date = document.getElementById('lab-date').value;
            const facility = document.getElementById('lab-facility').value;
            const notes = document.getElementById('lab-notes').value;
            
            if (!date) {
                alert('Please enter the test date');
                return;
            }
            
            // Collect all lab values
            const labResult = {
                id: Date.now(),
                date: new Date(date),
                facility: facility,
                notes: notes,
                // HbA1c
                hba1c: parseFloat(document.getElementById('lab-hba1c').value) || null,
                // Lipid Profile
                totalCholesterol: parseInt(document.getElementById('lab-total-chol').value) || null,
                ldl: parseInt(document.getElementById('lab-ldl').value) || null,
                hdl: parseInt(document.getElementById('lab-hdl').value) || null,
                triglycerides: parseInt(document.getElementById('lab-triglycerides').value) || null,
                // CMP
                glucose: parseInt(document.getElementById('lab-glucose').value) || null,
                creatinine: parseFloat(document.getElementById('lab-creatinine').value) || null,
                egfr: parseInt(document.getElementById('lab-egfr').value) || null,
                bun: parseInt(document.getElementById('lab-bun').value) || null,
                sodium: parseInt(document.getElementById('lab-sodium').value) || null,
                potassium: parseFloat(document.getElementById('lab-potassium').value) || null,
                // LFT
                alt: parseInt(document.getElementById('lab-alt').value) || null,
                ast: parseInt(document.getElementById('lab-ast').value) || null,
                bilirubin: parseFloat(document.getElementById('lab-bilirubin').value) || null,
                alkPhos: parseInt(document.getElementById('lab-alk-phos').value) || null,
                // Microalbuminuria
                microalbumin: parseFloat(document.getElementById('lab-microalbumin').value) || null,
                acr: parseFloat(document.getElementById('lab-acr').value) || null
            };
            
            // Check if at least one lab value was entered
            const hasLabValues = Object.keys(labResult).some(key => 
                key !== 'id' && key !== 'date' && key !== 'facility' && key !== 'notes' && labResult[key] !== null
            );
            
            if (!hasLabValues) {
                alert('Please enter at least one lab value');
                return;
            }
            
            labResults.unshift(labResult);
            localStorage.setItem('labResults', JSON.stringify(labResults));
            updateLabResultsDisplay();
            
            // Clear form
            clearLabForm();
            
            showSuccessMessage('Lab results saved successfully!');
            awardPoints(20, 'logging lab results');
        }
        
        function clearLabForm() {
            document.getElementById('lab-date').value = '';
            document.getElementById('lab-facility').value = '';
            document.getElementById('lab-notes').value = '';
            document.getElementById('lab-hba1c').value = '';
            document.getElementById('lab-total-chol').value = '';
            document.getElementById('lab-ldl').value = '';
            document.getElementById('lab-hdl').value = '';
            document.getElementById('lab-triglycerides').value = '';
            document.getElementById('lab-glucose').value = '';
            document.getElementById('lab-creatinine').value = '';
            document.getElementById('lab-egfr').value = '';
            document.getElementById('lab-bun').value = '';
            document.getElementById('lab-sodium').value = '';
            document.getElementById('lab-potassium').value = '';
            document.getElementById('lab-alt').value = '';
            document.getElementById('lab-ast').value = '';
            document.getElementById('lab-bilirubin').value = '';
            document.getElementById('lab-alk-phos').value = '';
            document.getElementById('lab-microalbumin').value = '';
            document.getElementById('lab-acr').value = '';
        }
        
        function updateLabResultsDisplay() {
            updateLabSummary();
            updateLabResultsList();
        }
        
        function updateLabSummary() {
            if (labResults.length === 0) {
                document.getElementById('latest-lab-hba1c').textContent = '--';
                document.getElementById('latest-lab-hba1c-date').textContent = 'No results';
                document.getElementById('latest-lab-ldl').textContent = '--';
                document.getElementById('latest-lab-ldl-date').textContent = 'No results';
                document.getElementById('latest-lab-egfr').textContent = '--';
                document.getElementById('latest-lab-egfr-date').textContent = 'No results';
                document.getElementById('latest-lab-acr').textContent = '--';
                document.getElementById('latest-lab-acr-date').textContent = 'No results';
                return;
            }
            
            // Find latest values for each metric
            const latestHbA1c = labResults.find(result => result.hba1c !== null);
            const latestLDL = labResults.find(result => result.ldl !== null);
            const latestEGFR = labResults.find(result => result.egfr !== null);
            const latestACR = labResults.find(result => result.acr !== null);
            
            // Update HbA1c
            if (latestHbA1c) {
                document.getElementById('latest-lab-hba1c').textContent = latestHbA1c.hba1c.toFixed(1) + '%';
                document.getElementById('latest-lab-hba1c-date').textContent = new Date(latestHbA1c.date).toLocaleDateString();
            }
            
            // Update LDL
            if (latestLDL) {
                document.getElementById('latest-lab-ldl').textContent = latestLDL.ldl + ' mg/dL';
                document.getElementById('latest-lab-ldl-date').textContent = new Date(latestLDL.date).toLocaleDateString();
            }
            
            // Update eGFR
            if (latestEGFR) {
                document.getElementById('latest-lab-egfr').textContent = latestEGFR.egfr + ' mL/min/1.73m¬≤';
                document.getElementById('latest-lab-egfr-date').textContent = new Date(latestEGFR.date).toLocaleDateString();
            }
            
            // Update ACR
            if (latestACR) {
                document.getElementById('latest-lab-acr').textContent = latestACR.acr + ' mg/g';
                document.getElementById('latest-lab-acr-date').textContent = new Date(latestACR.date).toLocaleDateString();
            }
        }
        
        function updateLabResultsList() {
            const list = document.getElementById('lab-results-list');
            list.innerHTML = '';
            
            if (labResults.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">No lab results yet. Add your first lab results!</p>';
                return;
            }
            
            labResults.slice(0, 10).forEach(result => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4';
                
                let labValues = [];
                
                // Add non-null values to display
                if (result.hba1c !== null) labValues.push(`HbA1c: ${result.hba1c.toFixed(1)}%`);
                if (result.ldl !== null) labValues.push(`LDL: ${result.ldl} mg/dL`);
                if (result.hdl !== null) labValues.push(`HDL: ${result.hdl} mg/dL`);
                if (result.triglycerides !== null) labValues.push(`Triglycerides: ${result.triglycerides} mg/dL`);
                if (result.creatinine !== null) labValues.push(`Creatinine: ${result.creatinine} mg/dL`);
                if (result.egfr !== null) labValues.push(`eGFR: ${result.egfr} mL/min/1.73m¬≤`);
                if (result.acr !== null) labValues.push(`ACR: ${result.acr} mg/g`);
                if (result.alt !== null) labValues.push(`ALT: ${result.alt} U/L`);
                if (result.ast !== null) labValues.push(`AST: ${result.ast} U/L`);
                
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800">Lab Results - ${new Date(result.date).toLocaleDateString()}</h3>
                        <span class="text-sm text-gray-500">${result.facility || 'Lab'}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-700 mb-2">
                        ${labValues.map(value => `<span class="bg-white px-2 py-1 rounded">${value}</span>`).join('')}
                    </div>
                    ${result.notes ? `<p class="text-sm text-gray-600 mt-2 italic">${result.notes}</p>` : ''}
                `;
                
                list.appendChild(div);
            });
        }
        
        function getLabStatus(value, type) {
            // Define normal ranges and return status
            const ranges = {
                hba1c: { normal: [0, 5.7], prediabetes: [5.7, 6.5], diabetes: [6.5, 20] },
                ldl: { optimal: [0, 100], near: [100, 130], borderline: [130, 160], high: [160, 190], veryHigh: [190, 999] },
                hdl: { low: [0, 40], normal: [40, 999] }, // For men, women is 50+
                triglycerides: { normal: [0, 150], borderline: [150, 200], high: [200, 500], veryHigh: [500, 999] },
                creatinine: { normal: [0.6, 1.2] }, // General range
                egfr: { normal: [90, 999], mild: [60, 89], moderate: [30, 59], severe: [15, 29], kidney: [0, 14] },
                acr: { normal: [0, 30], microalbumin: [30, 300], macroalbumin: [300, 999] }
            };
            
            // This is a simplified status checker - in real app would be more comprehensive
            return { status: 'normal', color: 'green' };
        }

        // Export Functions
        function exportData(format) {
            const range = document.getElementById('export-range').value;
            const includeGlucose = document.getElementById('export-glucose').checked;
            const includeInsulin = document.getElementById('export-insulin').checked;
            const includeMedication = document.getElementById('export-medication').checked;
            const includeFood = document.getElementById('export-food').checked;
            const includeExercise = document.getElementById('export-exercise').checked;
            const includeVitals = document.getElementById('export-vitals').checked;
            const includeHbA1c = document.getElementById('export-hba1c').checked;
            
            // Filter data by date range
            const cutoffDate = new Date();
            if (range !== 'all') {
                cutoffDate.setDate(cutoffDate.getDate() - parseInt(range));
            }
            
            const exportData = {
                profile: userProfile,
                diabetesType: diabetesType,
                exportDate: new Date(),
                dateRange: range === 'all' ? 'All data' : `Last ${range} days`
            };
            
            if (includeGlucose) {
                exportData.glucoseReadings = range === 'all' ? glucoseReadings : 
                    glucoseReadings.filter(r => new Date(r.date) >= cutoffDate);
            }
            
            if (includeInsulin) {
                exportData.insulinDoses = range === 'all' ? insulinDoses : 
                    insulinDoses.filter(d => new Date(d.date) >= cutoffDate);
            }
            
            if (includeMedication) {
                exportData.medications = medications;
            }
            
            if (includeFood) {
                exportData.foodItems = range === 'all' ? foodItems : 
                    foodItems.filter(f => new Date(f.date) >= cutoffDate);
            }
            
            if (includeExercise) {
                exportData.exercises = range === 'all' ? exercises : 
                    exercises.filter(e => new Date(e.date) >= cutoffDate);
            }
            
            if (includeVitals) {
                exportData.weightEntries = range === 'all' ? weightEntries : 
                    weightEntries.filter(w => new Date(w.date) >= cutoffDate);
                exportData.bloodPressureReadings = range === 'all' ? bloodPressureReadings : 
                    bloodPressureReadings.filter(bp => new Date(bp.date) >= cutoffDate);
            }
            
            if (includeHbA1c) {
                exportData.hba1cReadings = range === 'all' ? hba1cReadings : 
                    hba1cReadings.filter(h => new Date(h.date) >= cutoffDate);
            }
            
            // Include comprehensive lab results
            exportData.labResults = range === 'all' ? labResults : 
                labResults.filter(l => new Date(l.date) >= cutoffDate);
            
            if (format === 'json') {
                downloadJSON(exportData);
            } else if (format === 'csv') {
                downloadCSV(exportData);
            } else if (format === 'pdf') {
                downloadPDF(exportData);
            }
            
            awardPoints(15, 'exporting data');
        }

        function downloadJSON(data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diabetes-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccessMessage('JSON data exported successfully!');
        }

        function downloadCSV(data) {
            let csv = 'DiabetesTracker Pro - Health Data Export\n';
            csv += `Export Date: ${new Date().toLocaleDateString()}\n`;
            csv += `Date Range: ${data.dateRange}\n\n`;
            
            if (data.glucoseReadings) {
                csv += 'BLOOD GLUCOSE READINGS\n';
                csv += 'Date,Time,Level (mg/dL),Time of Reading,Notes\n';
                data.glucoseReadings.forEach(reading => {
                    csv += `${new Date(reading.date).toLocaleDateString()},${new Date(reading.date).toLocaleTimeString()},${reading.level},${reading.time},"${reading.notes || ''}"\n`;
                });
                csv += '\n';
            }
            
            if (data.insulinDoses) {
                csv += 'INSULIN DOSES\n';
                csv += 'Date,Time,Type,Dose (units),Site,Reason,BG Before,Notes\n';
                data.insulinDoses.forEach(dose => {
                    csv += `${new Date(dose.date).toLocaleDateString()},${new Date(dose.date).toLocaleTimeString()},${dose.type},${dose.dose},${dose.site},${dose.reason},${dose.bgBefore || ''},"${dose.notes || ''}"\n`;
                });
                csv += '\n';
            }
            
            if (data.foodItems) {
                csv += 'FOOD & NUTRITION\n';
                csv += 'Date,Time,Food,Quantity,Unit,Calories,Carbs (g),Fiber (g),Meal Type\n';
                data.foodItems.forEach(food => {
                    csv += `${new Date(food.date).toLocaleDateString()},${new Date(food.date).toLocaleTimeString()},${food.name},${food.quantity},${food.unit},${food.calories},${food.carbs},${food.fiber},${food.meal}\n`;
                });
                csv += '\n';
            }
            
            if (data.hba1cReadings) {
                csv += 'HbA1c RESULTS\n';
                csv += 'Date,HbA1c (%),Lab/Doctor,Notes\n';
                data.hba1cReadings.forEach(reading => {
                    csv += `${new Date(reading.date).toLocaleDateString()},${reading.value},${reading.lab || ''},"${reading.notes || ''}"\n`;
                });
                csv += '\n';
            }
            
            if (data.labResults && data.labResults.length > 0) {
                csv += 'COMPREHENSIVE LAB RESULTS\n';
                csv += 'Date,Facility,HbA1c (%),Total Chol,LDL,HDL,Triglycerides,Glucose,Creatinine,eGFR,BUN,Sodium,Potassium,ALT,AST,Bilirubin,Alk Phos,Microalbumin,ACR,Notes\n';
                data.labResults.forEach(result => {
                    csv += `${new Date(result.date).toLocaleDateString()},${result.facility || ''},${result.hba1c || ''},${result.totalCholesterol || ''},${result.ldl || ''},${result.hdl || ''},${result.triglycerides || ''},${result.glucose || ''},${result.creatinine || ''},${result.egfr || ''},${result.bun || ''},${result.sodium || ''},${result.potassium || ''},${result.alt || ''},${result.ast || ''},${result.bilirubin || ''},${result.alkPhos || ''},${result.microalbumin || ''},${result.acr || ''},"${result.notes || ''}"\n`;
                });
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diabetes-data-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccessMessage('CSV data exported successfully!');
        }

        function downloadPDF(data) {
            // Create a simple PDF-like HTML document
            let html = `
                <html>
                <head>
                    <title>Diabetes Health Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #2563eb; border-bottom: 2px solid #2563eb; }
                        h2 { color: #1f2937; margin-top: 30px; }
                        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f3f4f6; }
                        .summary { background-color: #f0f9ff; padding: 15px; border-radius: 5px; margin: 20px 0; }
                    </style>
                </head>
                <body>
                    <h1>ü©∫ DiabetesTracker Pro - Health Report</h1>
                    <div class="summary">
                        <p><strong>Export Date:</strong> ${new Date().toLocaleDateString()}</p>
                        <p><strong>Date Range:</strong> ${data.dateRange}</p>
                        <p><strong>Patient:</strong> ${data.profile.age ? `Age ${data.profile.age}, ${data.profile.sex}` : 'Profile not complete'}</p>
                        <p><strong>Diabetes Type:</strong> ${data.diabetesType || 'Not specified'}</p>
                    </div>
            `;
            
            if (data.glucoseReadings && data.glucoseReadings.length > 0) {
                const avgGlucose = data.glucoseReadings.reduce((sum, r) => sum + r.level, 0) / data.glucoseReadings.length;
                html += `
                    <h2>Blood Glucose Summary</h2>
                    <p><strong>Average Glucose:</strong> ${avgGlucose.toFixed(1)} mg/dL</p>
                    <p><strong>Total Readings:</strong> ${data.glucoseReadings.length}</p>
                    <table>
                        <tr><th>Date</th><th>Level (mg/dL)</th><th>Time of Reading</th><th>Notes</th></tr>
                `;
                data.glucoseReadings.slice(0, 20).forEach(reading => {
                    html += `<tr><td>${new Date(reading.date).toLocaleDateString()}</td><td>${reading.level}</td><td>${reading.time}</td><td>${reading.notes || ''}</td></tr>`;
                });
                html += '</table>';
            }
            
            if (data.hba1cReadings && data.hba1cReadings.length > 0) {
                html += `
                    <h2>HbA1c Results</h2>
                    <table>
                        <tr><th>Date</th><th>HbA1c (%)</th><th>Lab/Doctor</th><th>Notes</th></tr>
                `;
                data.hba1cReadings.forEach(reading => {
                    html += `<tr><td>${new Date(reading.date).toLocaleDateString()}</td><td>${reading.value}%</td><td>${reading.lab || ''}</td><td>${reading.notes || ''}</td></tr>`;
                });
                html += '</table>';
            }
            
            if (data.labResults && data.labResults.length > 0) {
                html += `
                    <h2>Comprehensive Lab Results</h2>
                    <table>
                        <tr><th>Date</th><th>Facility</th><th>Key Results</th><th>Notes</th></tr>
                `;
                data.labResults.slice(0, 10).forEach(result => {
                    let keyResults = [];
                    if (result.hba1c) keyResults.push(`HbA1c: ${result.hba1c.toFixed(1)}%`);
                    if (result.ldl) keyResults.push(`LDL: ${result.ldl} mg/dL`);
                    if (result.creatinine) keyResults.push(`Creatinine: ${result.creatinine} mg/dL`);
                    if (result.egfr) keyResults.push(`eGFR: ${result.egfr}`);
                    if (result.acr) keyResults.push(`ACR: ${result.acr} mg/g`);
                    
                    html += `<tr><td>${new Date(result.date).toLocaleDateString()}</td><td>${result.facility || 'Lab'}</td><td>${keyResults.join(', ')}</td><td>${result.notes || ''}</td></tr>`;
                });
                html += '</table>';
            }
            
            html += '</body></html>';
            
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diabetes-report-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccessMessage('PDF report exported successfully! (HTML format for easy printing)');
        }

        function updateExportCounts() {
            document.getElementById('export-glucose-count').textContent = glucoseReadings.length;
            document.getElementById('export-insulin-count').textContent = insulinDoses.length;
            document.getElementById('export-food-count').textContent = foodItems.length;
            document.getElementById('export-exercise-count').textContent = exercises.length;
            document.getElementById('export-hba1c-count').textContent = hba1cReadings.length;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96d376d6e437875c',t:'MTc1NDg3MDU0Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
